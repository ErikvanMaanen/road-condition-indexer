<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Records</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; }
        #controls { margin-bottom: 1rem; }
        button { padding: 0.5rem 1rem; font-size: 1rem; }
        #map { width: 100%; height: 60vh; margin-top: 1rem; }
        #map:fullscreen { width: 100%; height: 100%; }
        #controls input { margin-right: 0.5rem; }
    </style>
</head>
<body>
<h1>Device Records</h1>
<div id="controls">
    <select id="deviceId"></select>
    <select id="version">
        <option value="">All Versions</option>
        <option value="0.1">V0.1</option>
        <option value="0.2">V0.2</option>
    </select>
    <input id="startDate" type="datetime-local">
    <input id="endDate" type="datetime-local">
    <button id="load">Load</button>
    <button id="fullscreen-button">Fullscreen</button>
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;

function populateDeviceIds() {
    fetch('/device_ids').then(r => r.json()).then(data => {
        const sel = document.getElementById('deviceId');
        sel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = 'All Devices';
        sel.appendChild(optAll);
        data.ids.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.nickname ? `${item.nickname} (${item.id})` : item.id;
            sel.appendChild(opt);
        });
    }).then(() => setDateRange()).catch(console.error);
}

function setDateRange() {
    const device = document.getElementById('deviceId').value;
    const url = device ? `/date_range?device_id=${encodeURIComponent(device)}` : '/date_range';
    fetch(url).then(r => r.json()).then(data => {
        if (data.start) document.getElementById('startDate').value = data.start.slice(0,19);
        if (data.end) document.getElementById('endDate').value = data.end.slice(0,19);
    }).catch(console.error);
}

function initMap() {
    map = L.map('map').setView([52.028, 5.168], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
}

function colorForRoughness(r) {
    const ratio = Math.min(Math.max((r - 0) / (5 - 0), 0), 1);
    const red = Math.floor(255 * ratio);
    const green = Math.floor(255 * (1 - ratio));
    return `rgb(${red},${green},0)`;
}

function addMarker(lat, lon, roughness) {
    L.circleMarker([lat, lon], {
        radius: 6,
        color: colorForRoughness(roughness),
        fillColor: colorForRoughness(roughness),
        fillOpacity: 0.8
    }).addTo(map).bindPopup('Roughness: ' + roughness.toFixed(2));
}

function loadData() {
    const device = document.getElementById('deviceId').value;
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    const version = document.getElementById('version').value;
    const params = new URLSearchParams();
    if (device) params.append('device_id', device);
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    if (version) params.append('version', version);
    fetch('/filteredlogs?' + params.toString())
        .then(r => r.json())
        .then(data => {
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) map.removeLayer(layer);
            });
            data.rows.reverse().forEach(row =>
                addMarker(row.latitude, row.longitude, row.roughness));
        })
        .catch(console.error);
}

initMap();
populateDeviceIds();
document.getElementById('load').addEventListener('click', loadData);
document.getElementById('deviceId').addEventListener('change', setDateRange);
document.getElementById('version').addEventListener('change', loadData);
document.getElementById('fullscreen-button').addEventListener('click', () => {
    const el = document.getElementById('map');
    if (!document.fullscreenElement) {
        if (el.requestFullscreen) {
            el.requestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        }
    }
});

document.addEventListener('fullscreenchange', () => {
    if (map) {
        map.invalidateSize();
    }
});
</script>
</body>
</html>
