<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="utils.js"></script>
    <script src="map-components.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0 auto; padding: 1rem; max-width: 1000px; }
        #controls { margin-bottom: 1rem; display:flex; flex-wrap:wrap; gap:0.5rem; }
        button { padding: 0.5rem 1rem; font-size: 1rem; }
        button.danger { background: #dc3545; color: white; }
        button.danger:hover { background: #c82333; }
        button.warning { background: #ffc107; color: black; }
        button.warning:hover { background: #e0a800; }
        #controls input { margin-right: 0.5rem; }
        
        /* Dual Range Slider Styles */
        .time-range-container {
            position: relative;
            margin: 1rem 0;
        }
        .time-range-slider {
            position: relative;
            height: 60px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        .time-range-track {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            transform: translateY(-50%);
        }
        .time-range-fill {
            position: absolute;
            height: 100%;
            background: linear-gradient(to right, #28a745, #20c997);
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        .time-range-handle {
            position: absolute;
            top: 50%;
            width: 20px;
            height: 20px;
            background: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            z-index: 2;
        }
        .time-range-handle:hover {
            background: #0056b3;
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        .time-range-handle.active {
            background: #dc3545;
            transform: translate(-50%, -50%) scale(1.2);
        }
        .time-range-handle.start {
            background: #28a745;
        }
        .time-range-handle.end {
            background: #ffc107;
        }
        .time-range-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #6c757d;
        }
        .time-range-info {
            text-align: center;
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #1976d2;
            margin: 0 10px;
        }
        .time-range-controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
            margin-bottom: 0.5rem;
        }
        .time-input-group {
            display: flex;
            flex-direction: column;
        }
        .time-input-group label {
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        .time-input-group input {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .quick-time-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .quick-time-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quick-time-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        .quick-time-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        #log {
            width: 100%;
            height: 150px;
            overflow: auto;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
            white-space: pre;
        }
        #debug {
            width: 100%;
            height: 150px;
            margin-top: 1rem;
        }
        .data-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .data-info h3 {
            margin-top: 0;
        }
        .confirmation-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }
        .confirmation-box.danger {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .form-group textarea {
            height: 100px;
        }
        #loading {
            display: none;
            text-align: center;
            padding: 1rem;
        }
        #device-management, #records-overview {
            max-width: 800px;
        }
        #device-management h5, #records-overview h5 {
            margin: 0.5rem 0;
            color: #495057;
        }
        .device-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .device-item:last-child {
            border-bottom: none;
        }
        table {
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        /* Device Management Section Styles */
        .device-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .device-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .device-id {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1rem;
        }
        .device-nickname {
            color: #6c757d;
            font-style: italic;
        }
        .device-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin: 0.5rem 0;
        }
        .device-stat {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .device-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }
        .device-stat-value {
            font-weight: bold;
            color: #495057;
        }
        .device-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .device-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.9rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-edit {
            background: #ffc107;
            color: #212529;
        }
        .btn-edit:hover {
            background: #e0a800;
        }
        .btn-delete-device {
            background: #dc3545;
            color: white;
        }
        .btn-delete-device:hover {
            background: #c82333;
        }
        .btn-delete-data {
            background: #8b0000;
            color: white;
            font-weight: bold;
        }
        .btn-delete-data:hover {
            background: #660000;
        }
        .device-management-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .device-form {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .edit-form {
            display: none;
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .edit-form.active {
            display: block;
        }
        
        /* Collapsible Section Styles */
        .collapsible-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .collapsible-header {
            background: #f8f9fa;
            padding: 1rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        .collapsible-header:hover {
            background: #e9ecef;
        }
        .collapsible-header h2,
        .collapsible-header h3 {
            margin: 0;
            color: #495057;
        }
        .collapsible-toggle {
            font-size: 1.2rem;
            color: #6c757d;
            transition: transform 0.2s ease;
        }
        .collapsible-content {
            padding: 1rem;
            display: none;
        }
        .collapsible-content.expanded {
            display: block;
        }
        .collapsible-section.expanded .collapsible-toggle {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
<nav id="page-links" style="margin-bottom:1rem;">
    <a href="/">Main</a> |
    <a href="device.html">Device View</a> |
    <a href="maintenance.html">Maintenance</a>
</nav>
<h1><img src="/static/logo.png" alt="Road Condition Indexer Logo" style="height: 2em; vertical-align: middle; margin-right: 0.5em;">Database Management</h1>

<!-- Device Filter Section - Always Visible -->
<section id="filter-dev-section" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa;">
    <h3 style="margin: 0 0 1rem 0; color: #495057;">Device Filter</h3>
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
        <select id="deviceId" multiple></select>
        <button onclick="refreshSelection()">Refresh Selection</button>
    </div>
</section>

<!-- Map Section - Always Visible -->
<section id="map-section" style="margin-bottom: 1rem; padding: 1rem; border: 1px solid #dee2e6; border-radius: 8px; background: #f8f9fa;">
    <h3 style="margin: 0 0 1rem 0; color: #495057;">Map View</h3>
    <!-- Include standardized map component -->
    <div id="map-container"></div>
</section>

<div id="loading">Loading data...</div>

<section id="data-summary-section" class="collapsible-section">
    <div class="collapsible-header" onclick="toggleSection('data-summary-content')">
        <h3>Selected Data Summary</h3>
        <span class="collapsible-toggle">▼</span>
    </div>
    <div id="data-summary-content" class="collapsible-content">
        <div class="data-info">
            <p id="data-summary">Select devices and time range to see data summary</p>
        </div>
    </div>
</section>

<section id="database-operations-section" class="collapsible-section">
    <div class="collapsible-header" onclick="toggleSection('database-operations')">
        <h3>Database Operations</h3>
        <span class="collapsible-toggle">▼</span>
    </div>
    <div id="database-operations" class="collapsible-content">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button onclick="showUpdateForm()" class="warning">Update Selected Data</button>
            <button onclick="showDeleteConfirmation()" class="danger">Delete Selected Data</button>
            <button onclick="exportSelectedData()">Export Selected Data</button>
            <button onclick="showRecordOverview()">Records Overview</button>
        </div>
    </div>
</section>

<!-- Device Management Section -->
<section id="device-management-section" class="collapsible-section">
    <div class="collapsible-header" onclick="toggleSection('device-management')">
        <h2>Device Management</h2>
        <span class="collapsible-toggle">▼</span>
    </div>
    <div id="device-management" class="collapsible-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <p>Manage all registered devices, their nicknames, and view record statistics.</p>
            <button onclick="refreshDeviceList()" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Refresh List</button>
        </div>
        
        <div id="device-list-container">
            Loading devices...
        </div>
    </div>
</section>

<!-- Update Form -->
<div id="update-form" class="confirmation-box">
    <h4>Update Selected Records</h4>
    <p>Update the following fields for all selected records:</p>
    <div class="form-group">
        <label for="update-roughness">Roughness Value:</label>
        <input type="number" id="update-roughness" step="0.001" placeholder="Leave empty to keep current values">
    </div>
    <div class="form-group">
        <label for="update-speed">Speed (km/h):</label>
        <input type="number" id="update-speed" step="0.1" placeholder="Leave empty to keep current values">
    </div>
    <div class="form-group">
        <label for="update-direction">Direction (degrees):</label>
        <input type="number" id="update-direction" min="0" max="360" placeholder="Leave empty to keep current values">
    </div>
    <div style="margin-top: 1rem;">
        <button onclick="executeUpdate()" class="warning">Execute Update</button>
        <button onclick="hideUpdateForm()">Cancel</button>
    </div>
</div>

<!-- Delete Confirmation -->
<div id="delete-confirmation" class="confirmation-box danger">
    <h4>⚠️ Confirm Deletion</h4>
    <p>You are about to permanently delete <span id="delete-count">0</span> records.</p>
    <p><strong>This action cannot be undone!</strong></p>
    <div style="margin-top: 1rem;">
        <button onclick="executeDelete()" class="danger">DELETE RECORDS</button>
        <button onclick="hideDeleteConfirmation()">Cancel</button>
    </div>
</div>

<!-- Records Overview -->
<div id="records-overview" class="confirmation-box">
    <h4>Records Overview by Device</h4>
    <div id="records-overview-content" style="max-height: 400px; overflow-y: auto;">
        Loading overview...
    </div>
    <div style="margin-top: 1rem;">
        <button onclick="hideRecordOverview()">Close</button>
        <button onclick="refreshRecordOverview()">Refresh</button>
    </div>
</div>

<!-- Include Activity Log and Debug Messages Partial -->
<div id="logs-container"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let selectedIds = [];
let deviceNicknames = {};
let roughMin = 0;
let roughMax = LABEL_COUNT;
let roughAvg = 0;
let roughScales = {};
let sliderMin = 0;
let sliderMax = 0;
let selectedData = [];

// Collapsible section toggle function
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId);
    const section = content.closest('.collapsible-section');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        section.classList.remove('expanded');
    } else {
        content.classList.add('expanded');
        section.classList.add('expanded');
    }
}

function populateDeviceIds() {
    fetch('/device_ids').then(r => r.json()).then(data => {
        const sel = document.getElementById('deviceId');
        sel.innerHTML = '';
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = '[All Devices]';
        sel.appendChild(optAll);
        deviceNicknames = {};
        data.ids.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.nickname ? `${item.nickname} (${item.id})` : item.id;
            deviceNicknames[item.id] = item.nickname || item.id;
            sel.appendChild(opt);
        });
        Array.from(sel.options).forEach(o => {
            if (selectedIds.includes(o.value)) o.selected = true;
        });
        selectedIds = Array.from(sel.selectedOptions).map(o => o.value).filter(v => v);
    }).then(() =>
        setDateRange().then(() => {
            loadData();
        })
    ).catch(console.error);
}

function setDateRange() {
    const sel = document.getElementById('deviceId');
    const ids = Array.from(sel.selectedOptions).map(o => o.value).filter(v => v);
    let url = '/date_range';
    if (ids.length > 0) {
        const params = new URLSearchParams();
        ids.forEach(id => params.append('device_id', id));
        url = '/date_range?' + params.toString();
    }
    
    return fetch(url).then(r => r.json()).then(data => {
        if (data.start && data.end) {
            // Update the complete time range limits for sliders
            sliderMin = Date.parse(data.start);
            sliderMax = Date.parse(data.end);
            
            // Update the time range slider from map-partial if available
            if (window.timeRangeSlider && typeof window.timeRangeSlider.setRange === 'function') {
                window.timeRangeSlider.setRange(sliderMin, sliderMax, sliderMin, sliderMax);
            }
            
            // Dispatch data range update event
            window.dispatchEvent(new CustomEvent('dataRangeUpdated', {
                detail: { startTime: sliderMin, endTime: sliderMax }
            }));
            
            // Log the updated range for user feedback
            const deviceText = ids.length === 0 ? 'all devices' : 
                ids.length === 1 ? `device ${deviceNicknames[ids[0]] || ids[0]}` : 
                `${ids.length} selected devices`;
            addLog(`Updated time range for ${deviceText}: ${new Date(data.start).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'})} - ${new Date(data.end).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'})}`);
        } else {
            addLog('No data available for selected devices');
        }
    }).catch(error => {
        console.error('Error fetching date range:', error);
        addDebug('Error fetching date range: ' + error.message);
    });
}

function syncRanges() {
    // This function is now handled by the map-partial time slider
    // No need to manually sync ranges as the time slider handles this automatically
    console.log('syncRanges called - now handled by map-partial time slider');
}

function updateTimeRangeSlider() {
    // This function is now handled by the map-partial time slider
    // Time range updates are handled via events from the time slider
    console.log('updateTimeRangeSlider called - now handled by map-partial time slider');
}
        const slider = document.getElementById('timeRangeSlider');
        const startHandle = document.getElementById('startHandle');
        const endHandle = document.getElementById('endHandle');
        
        // Mouse events
        startHandle.addEventListener('mousedown', (e) => this.startDrag(e, 'start'));
        endHandle.addEventListener('mousedown', (e) => this.startDrag(e, 'end'));
        slider.addEventListener('click', (e) => this.handleTrackClick(e));
        
        // Touch events for mobile
        startHandle.addEventListener('touchstart', (e) => this.startDrag(e, 'start'));
        endHandle.addEventListener('touchstart', (e) => this.startDrag(e, 'end'));
        
        document.addEventListener('mousemove', (e) => this.drag(e));
        document.addEventListener('mouseup', () => this.stopDrag());
        document.addEventListener('touchmove', (e) => this.drag(e));
        document.addEventListener('touchend', () => this.stopDrag());
        
        // Prevent text selection while dragging
        slider.addEventListener('selectstart', (e) => e.preventDefault());
    },
    
    setRange(minTime, maxTime, startTime, endTime) {
        this.minTime = minTime;
        this.maxTime = maxTime;
        this.startTime = startTime || minTime;
        this.endTime = endTime || maxTime;
        this.updateDisplay();
    },
    
    startDrag(e, handle) {
        e.preventDefault();
        this.isDragging = true;
        this.activeHandle = handle;
        
        const handleEl = document.getElementById(handle + 'Handle');
        handleEl.classList.add('active');
        
        document.body.style.userSelect = 'none';
        document.body.style.cursor = 'grabbing';
    },
    
    drag(e) {
        if (!this.isDragging || !this.activeHandle) return;
        
        e.preventDefault();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        this.updatePosition(clientX);
    },
    
    stopDrag() {
        if (!this.isDragging) return;
        
        this.isDragging = false;
        document.body.style.userSelect = '';
        document.body.style.cursor = '';
        
        if (this.activeHandle) {
            const handleEl = document.getElementById(this.activeHandle + 'Handle');
            handleEl.classList.remove('active');
            this.activeHandle = null;
            
            // Update date inputs and load data
            this.updateDateInputs();
            setTimeout(() => loadData(), 100);
        }
    },
    
    handleTrackClick(e) {
        if (this.isDragging) return;
        
        const rect = e.currentTarget.getBoundingClientRect();
        const clickX = e.clientX - rect.left - 10; // Account for padding
        const trackWidth = rect.width - 20; // Account for padding
        const percentage = Math.max(0, Math.min(1, clickX / trackWidth));
        const clickTime = this.minTime + (this.maxTime - this.minTime) * percentage;
        
        // Move the closest handle to the click position
        const startDistance = Math.abs(clickTime - this.startTime);
        const endDistance = Math.abs(clickTime - this.endTime);
        
        if (startDistance < endDistance) {
            this.startTime = Math.max(this.minTime, Math.min(clickTime, this.endTime - 3600000)); // Min 1 hour apart
        } else {
            this.endTime = Math.min(this.maxTime, Math.max(clickTime, this.startTime + 3600000)); // Min 1 hour apart
        }
        
        this.updateDisplay();
        this.updateDateInputs();
        setTimeout(() => loadData(), 100);
    },
    
    updatePosition(clientX) {
        const slider = document.getElementById('timeRangeSlider');
        const rect = slider.getBoundingClientRect();
        const trackWidth = rect.width - 20; // Account for padding
        const relativeX = clientX - rect.left - 10; // Account for padding
        const percentage = Math.max(0, Math.min(1, relativeX / trackWidth));
        const newTime = this.minTime + (this.maxTime - this.minTime) * percentage;
        
        if (this.activeHandle === 'start') {
            this.startTime = Math.max(this.minTime, Math.min(newTime, this.endTime - 3600000)); // Min 1 hour apart
        } else if (this.activeHandle === 'end') {
            this.endTime = Math.min(this.maxTime, Math.max(newTime, this.startTime + 3600000)); // Min 1 hour apart
        }
        
        this.updateDisplay();
    },
    
    updateDisplay() {
        if (this.maxTime <= this.minTime) return;
        
        const totalRange = this.maxTime - this.minTime;
        const startPercent = ((this.startTime - this.minTime) / totalRange) * 100;
        const endPercent = ((this.endTime - this.minTime) / totalRange) * 100;
        
        // Update handles
        const startHandle = document.getElementById('startHandle');
        const endHandle = document.getElementById('endHandle');
        const fill = document.getElementById('timeRangeFill');
        
        startHandle.style.left = `calc(${startPercent}% + 10px)`;
        endHandle.style.left = `calc(${endPercent}% + 10px)`;
        
        // Update fill
        fill.style.left = `${startPercent}%`;
        fill.style.width = `${endPercent - startPercent}%`;
        
        // Update info
        this.updateRangeInfo();
    },
    
    updateRangeInfo() {
        const duration = this.endTime - this.startTime;
        const days = Math.ceil(duration / (1000 * 60 * 60 * 24));
        const hours = Math.ceil(duration / (1000 * 60 * 60));
        
        let durationText;
        if (days > 1) {
            durationText = `${days} days`;
        } else if (hours > 1) {
            durationText = `${hours} hours`;
        } else {
            durationText = `${Math.ceil(duration / (1000 * 60))} minutes`;
        }
        
        document.getElementById('rangeInfo').textContent = durationText;
        
        // Update min/max labels - display in Amsterdam time
        document.getElementById('minTimeLabel').textContent = 
            this.minTime ? new Date(this.minTime).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'}) : 'No data';
        document.getElementById('maxTimeLabel').textContent = 
            this.maxTime ? new Date(this.maxTime).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'}) : 'available';
    },
    
    updateDateInputs() {
        this.isUpdatingInputs = true;
        document.getElementById('startDate').value = toCESTDateTimeLocal(new Date(this.startTime).toISOString());
        document.getElementById('endDate').value = toCESTDateTimeLocal(new Date(this.endTime).toISOString());
        setTimeout(() => {
            this.isUpdatingInputs = false;
        }, 10);
    },
    
    setFromDateInputs() {
        // Prevent update loops when slider is updating inputs
        if (this.isUpdatingInputs) {
            return;
        }
        
        const startValue = document.getElementById('startDate').value;
        const endValue = document.getElementById('endDate').value;
        
        if (startValue && endValue) {
            // Convert Amsterdam time input to UTC timestamps
            const startUtc = fromCESTDateTimeLocal(startValue);
            const endUtc = fromCESTDateTimeLocal(endValue);
            
            this.startTime = Date.parse(startUtc);
            this.endTime = Date.parse(endUtc);
            
            // Clamp to available range
            this.startTime = Math.max(this.minTime, Math.min(this.startTime, this.maxTime));
            this.endTime = Math.max(this.minTime, Math.min(this.endTime, this.maxTime));
            
            // Ensure proper order
            if (this.startTime >= this.endTime) {
                this.endTime = Math.min(this.maxTime, this.startTime + 3600000);
            }
            
            this.updateDisplay();
        }
    }
};

function updateTimeRangeSlider() {
    // Prevent update loops when slider is updating inputs
    if (timeRangeSlider.isUpdatingInputs) {
        return;
    }
    
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    
    if (startVal && endVal && !isNaN(sliderMin) && !isNaN(sliderMax)) {
        // Convert Amsterdam time inputs to UTC timestamps
        const startUtc = Date.parse(fromCESTDateTimeLocal(startVal));
        const endUtc = Date.parse(fromCESTDateTimeLocal(endVal));
function syncRanges() {
    // This function is now handled by the map-partial time slider
    // No need to manually sync ranges as the time slider handles this automatically
    console.log('syncRanges called - now handled by map-partial time slider');
}

function updateTimeRangeSlider() {
    // This function is now handled by the map-partial time slider
    // Time range updates are handled via events from the time slider
    console.log('updateTimeRangeSlider called - now handled by map-partial time slider');
}

function applyQuickTimeRange(rangeType) {
    // Get current time in Amsterdam timezone
    const nowUtc = new Date();
    const nowAmsterdam = new Date(nowUtc.toLocaleString("sv-SE", {timeZone: "Europe/Amsterdam"}));
    
    // Work with Amsterdam timezone dates
    const todayAmsterdam = new Date(nowAmsterdam.getFullYear(), nowAmsterdam.getMonth(), nowAmsterdam.getDate());
    let startDate, endDate;
    
    // Clear active state from all buttons
    document.querySelectorAll('.quick-time-btn').forEach(btn => btn.classList.remove('active'));
    
    switch (rangeType) {
        case 'today':
            startDate = new Date(todayAmsterdam);
            endDate = new Date(nowAmsterdam);
            break;
        case 'yesterday':
            startDate = new Date(todayAmsterdam.getTime() - 24 * 60 * 60 * 1000);
            endDate = new Date(todayAmsterdam.getTime() - 1);
            break;
        case 'last7days':
            startDate = new Date(todayAmsterdam.getTime() - 7 * 24 * 60 * 60 * 1000);
            endDate = new Date(nowAmsterdam);
            break;
        case 'last30days':
            startDate = new Date(todayAmsterdam.getTime() - 30 * 24 * 60 * 60 * 1000);
            endDate = new Date(nowAmsterdam);
            break;
        case 'thisweek':
            const dayOfWeek = todayAmsterdam.getDay();
            const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDate = new Date(todayAmsterdam.getTime() - mondayOffset * 24 * 60 * 60 * 1000);
            endDate = new Date(nowAmsterdam);
            break;
        case 'thismonth':
            startDate = new Date(nowAmsterdam.getFullYear(), nowAmsterdam.getMonth(), 1);
            endDate = new Date(nowAmsterdam);
            break;
        case 'all':
            if (sliderMin && sliderMax) {
                startDate = new Date(sliderMin);
                endDate = new Date(sliderMax);
            } else {
                return;
            }
            break;
        default:
            return;
    }
    
    // Convert Amsterdam time to UTC for internal processing, except for 'all' case
    let startUtc, endUtc;
    if (rangeType === 'all') {
        // For 'all', dates are already UTC timestamps
        startUtc = startDate.getTime();
        endUtc = endDate.getTime();
    } else {
        // Convert Amsterdam time to UTC
        const startAmsterdamStr = startDate.toISOString().slice(0, 19);
        const endAmsterdamStr = endDate.toISOString().slice(0, 19);
        startUtc = Date.parse(fromCESTDateTimeLocal(startAmsterdamStr));
        endUtc = Date.parse(fromCESTDateTimeLocal(endAmsterdamStr));
    }
    
    // Clamp to available range (which is in UTC)
    if (sliderMin && startUtc < sliderMin) {
        startUtc = sliderMin;
    }
    if (sliderMax && endUtc > sliderMax) {
        endUtc = sliderMax;
    }
    
    // Set active state on clicked button
    document.querySelector(`[data-range="${rangeType}"]`).classList.add('active');
    
    // Update the time range slider from map-partial if available
    if (window.timeRangeSlider && typeof window.timeRangeSlider.setTimeRange === 'function') {
        window.timeRangeSlider.setTimeRange(sliderMin, sliderMax, startUtc, endUtc);
    }
    
    // Dispatch time range change event
    window.dispatchEvent(new CustomEvent('timeRangeChanged', {
        detail: { startTime: startUtc, endTime: endUtc, rangeType: rangeType }
    }));
    
    // Load data
    loadData();
    // Display times in Amsterdam timezone for log message
    const startAmsterdamLog = new Date(startUtc).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'});
    const endAmsterdamLog = new Date(endUtc).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'});
    addLog(`Applied ${rangeType} time range: ${startAmsterdamLog} - ${endAmsterdamLog}`);
}

// Map initialization now handled centrally in page initialization

function directionToCompass(deg) {
    if (deg === null || isNaN(deg)) return 'N/A';
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const idx = Math.round((deg % 360) / 45) % 8;
    return directions[idx];
}

function addPoint(lat, lon, roughness, info = null, nickname = '', min = null, max = null) {
    if (!map || (lat === 0 && lon === 0)) return;
    const opts = {
        color: colorForRoughness(roughness, min, max),
        radius: 4,
        weight: 1,
        opacity: 0.9,
        fillOpacity: 0.9
    };
    const marker = L.circleMarker([lat, lon], opts).addTo(map);
    
    let popup = `Roughness: ${roughness.toFixed(2)}`;
    if (nickname) popup = `Device: ${nickname}<br>` + popup;
    if (info) {
        const timeStr = new Date(info.timestamp).toLocaleString('nl-NL', { timeZone: 'Europe/Amsterdam' });
        popup = `Time: ${timeStr}<br>` +
                `Speed: ${info.speed.toFixed(1)} km/h<br>` +
                `Dir: ${directionToCompass(info.direction)}<br>` +
                `Roughness: ${roughness.toFixed(2)}<br>` +
                `ID: ${info.id}`;
        if (nickname) popup = `Device: ${nickname}<br>` + popup;
    }
    marker.bindPopup(popup);
}

function loadData() {
    const sel = document.getElementById('deviceId');
    const ids = Array.from(sel.selectedOptions).map(o => o.value).filter(v => v);
    
    // Get time range from time slider if available, otherwise use fallback
    let start, end;
    if (window.timeRangeSlider && window.timeRangeSlider.currentStart && window.timeRangeSlider.currentEnd) {
        // Convert from timestamp to ISO string for the API
        start = new Date(window.timeRangeSlider.currentStart).toISOString();
        end = new Date(window.timeRangeSlider.currentEnd).toISOString();
    } else {
        // Fallback to input fields if they exist
        const startField = document.getElementById('startDate');
        const endField = document.getElementById('endDate');
        if (startField && startField.value) {
            start = fromCESTDateTimeLocal(startField.value);
        }
        if (endField && endField.value) {
            end = fromCESTDateTimeLocal(endField.value);
        }
    }
    
    const params = new URLSearchParams();
    ids.forEach(id => params.append('device_id', id));
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    
    document.getElementById('loading').style.display = 'block';
    
    fetch('/filteredlogs?' + params.toString())
        .then(r => r.json())
        .then(async data => {
            const rows = data.rows || [];
            selectedData = rows;
            roughAvg = data.average || 0;
            
            // Clear map
            clearMapData();
            
            roughMin = 0;
            roughMax = roughAvg > 0 ? roughAvg * 2 : 1;
            roughScales = {};
            rows.forEach(row => {
                const s = roughScales[row.device_id] || {min: row.roughness, max: row.roughness};
                s.min = Math.min(s.min, row.roughness);
                s.max = Math.max(s.max, row.roughness);
                roughScales[row.device_id] = s;
            });
            
            // Add points to map
            for (let i = rows.length - 1; i >= 0; i--) {
                const row = rows[i];
                const name = deviceNicknames[row.device_id] || '';
                const scale = roughScales[row.device_id] || {min:0,max:1};
                addPoint(row.latitude, row.longitude, row.roughness, row, name, scale.min, scale.max);
            }
            
            document.getElementById('loading').style.display = 'none';
            updateDataSummary(rows);
            addLog(`Loaded ${rows.length} records`);
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            console.error(error);
            addDebug('Error loading data: ' + error.message);
        });
}

function updateDataSummary(data) {
    const summary = document.getElementById('data-summary');
    if (data.length === 0) {
        summary.textContent = 'No records found for selected criteria';
        return;
    }
    
    const deviceCounts = {};
    let minTime = null;
    let maxTime = null;
    
    data.forEach(record => {
        deviceCounts[record.device_id] = (deviceCounts[record.device_id] || 0) + 1;
        // Parse UTC timestamp and convert to local time for display
        const recordTime = new Date(record.timestamp);
        if (!minTime || recordTime < minTime) minTime = recordTime;
        if (!maxTime || recordTime > maxTime) maxTime = recordTime;
    });
    
    const deviceList = Object.entries(deviceCounts)
        .map(([id, count]) => `${deviceNicknames[id] || id}: ${count} records`)
        .join(', ');
    
    // Display times in local timezone
    const timeRange = minTime && maxTime ? 
        `${minTime.toLocaleString('nl-NL', { timeZone: 'Europe/Amsterdam' })} - ${maxTime.toLocaleString('nl-NL', { timeZone: 'Europe/Amsterdam' })}` : 
        'Unknown';
    
    summary.innerHTML = `
        <strong>Total Records:</strong> ${data.length}<br>
        <strong>Devices:</strong> ${deviceList}<br>
        <strong>Time Range:</strong> ${timeRange}<br>
        <strong>Average Roughness:</strong> ${roughAvg.toFixed(3)}
    `;
}

// Helper function to hide all modal forms
function hideAllForms() {
    document.getElementById('update-form').style.display = 'none';
    document.getElementById('delete-confirmation').style.display = 'none';
    document.getElementById('records-overview').style.display = 'none';
}

function refreshSelection() {
    setDateRange().then(loadData);
}

function showUpdateForm() {
    if (selectedData.length === 0) {
        alert('No data selected. Please select devices and time range first.');
        return;
    }
    hideAllForms();
    document.getElementById('update-form').style.display = 'block';
}

function hideUpdateForm() {
    document.getElementById('update-form').style.display = 'none';
    // Clear form
    document.getElementById('update-roughness').value = '';
    document.getElementById('update-speed').value = '';
    document.getElementById('update-direction').value = '';
}

function showDeleteConfirmation() {
    if (selectedData.length === 0) {
        alert('No data selected. Please select devices and time range first.');
        return;
    }
    document.getElementById('delete-count').textContent = selectedData.length;
    hideAllForms();
    document.getElementById('delete-confirmation').style.display = 'block';
}

function hideDeleteConfirmation() {
    document.getElementById('delete-confirmation').style.display = 'none';
}

async function executeUpdate() {
    const roughness = document.getElementById('update-roughness').value;
    const speed = document.getElementById('update-speed').value;
    const direction = document.getElementById('update-direction').value;
    
    if (!roughness && !speed && !direction) {
        alert('Please specify at least one field to update.');
        return;
    }
    
    const updates = {};
    if (roughness) updates.roughness = parseFloat(roughness);
    if (speed) updates.speed = parseFloat(speed);
    if (direction) updates.direction = parseFloat(direction);
    
    if (!confirm(`Update ${selectedData.length} records with the specified values?`)) {
        return;
    }
    
    try {
        const recordIds = selectedData.map(record => record.id);
        
        for (const id of recordIds) {
            const response = await authFetch('/manage/update_record', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, ...updates })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to update record ${id}`);
            }
        }
        
        addLog(`Successfully updated ${recordIds.length} records`);
        hideUpdateForm();
        loadData(); // Refresh the data
        
    } catch (error) {
        addDebug('Update failed: ' + error.message);
        alert('Update failed: ' + error.message);
    }
}

async function executeDelete() {
    if (!confirm('ARE YOU SURE? This will permanently delete all selected records!')) {
        return;
    }
    
    try {
        const recordIds = selectedData.map(record => record.id);
        
        for (const id of recordIds) {
            const response = await authFetch(`/manage/delete_record?record_id=${id}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`Failed to delete record ${id}`);
            }
        }
        
        addLog(`Successfully deleted ${recordIds.length} records`);
        hideDeleteConfirmation();
        loadData(); // Refresh the data
        
    } catch (error) {
        addDebug('Delete failed: ' + error.message);
        alert('Delete failed: ' + error.message);
    }
}

function exportSelectedData() {
    if (selectedData.length === 0) {
        alert('No data selected to export.');
        return;
    }
    
    const headers = ['ID', 'Timestamp', 'Device ID', 'Latitude', 'Longitude', 'Speed', 'Direction', 'Roughness', 'Distance'];
    const csvContent = [
        headers.join(','),
        ...selectedData.map(record => [
            record.id,
            `"${record.timestamp}"`,
            `"${record.device_id}"`,
            record.latitude,
            record.longitude,
            record.speed,
            record.direction,
            record.roughness,
            record.distance_m || ''
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
    a.download = `bike_data_export_${timestamp}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    addLog(`Exported ${selectedData.length} records to CSV`);
}

// Enhanced Device Management Functions
async function refreshDeviceList() {
    try {
        document.getElementById('device-list-container').innerHTML = 'Loading devices...';
        await loadDeviceList();
        addLog('Device list refreshed');
    } catch (error) {
        addDebug('Failed to refresh device list: ' + error.message);
    }
}

async function loadDeviceList() {
    try {
        const response = await authFetch('/device_ids');
        const data = await response.json();
        
        const deviceListContainer = document.getElementById('device-list-container');
        if (data.ids && data.ids.length > 0) {
            // Get detailed statistics for each device
            const deviceCards = [];
            
            for (const device of data.ids) {
                try {
                    // Get detailed device statistics
                    const statsResponse = await authFetch(`/device_stats?device_id=${device.id}`);
                    const stats = await statsResponse.json();
                    
                    const totalRecords = (stats.table_counts?.bike_data || 0) + (stats.table_counts?.source_data || 0);
                    
                    let firstRecord = 'N/A';
                    let lastRecord = 'N/A';
                    
                    if (stats.first_record && stats.last_record) {
                        firstRecord = new Date(stats.first_record).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'});
                        lastRecord = new Date(stats.last_record).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'});
                    }
                    
                    deviceCards.push(`
                        <div class="device-card">
                            <div class="device-card-header">
                                <div>
                                    <div class="device-id">${device.id}</div>
                                    <div class="device-nickname">${device.nickname || 'No nickname set'}</div>
                                </div>
                            </div>
                            <div class="device-stats">
                                <div class="device-stat">
                                    <div class="device-stat-label">Bike Data Records</div>
                                    <div class="device-stat-value">${(stats.table_counts?.bike_data || 0).toLocaleString()}</div>
                                </div>
                                <div class="device-stat">
                                    <div class="device-stat-label">Source Data Records</div>
                                    <div class="device-stat-value">${(stats.table_counts?.source_data || 0).toLocaleString()}</div>
                                </div>
                                <div class="device-stat">
                                    <div class="device-stat-label">Total Records</div>
                                    <div class="device-stat-value">${totalRecords.toLocaleString()}</div>
                                </div>
                                <div class="device-stat">
                                    <div class="device-stat-label">Average Roughness</div>
                                    <div class="device-stat-value">${(stats.average_roughness || 0).toFixed(3)}</div>
                                </div>
                                <div class="device-stat">
                                    <div class="device-stat-label">First Record</div>
                                    <div class="device-stat-value">${firstRecord}</div>
                                </div>
                                <div class="device-stat">
                                    <div class="device-stat-label">Last Record</div>
                                    <div class="device-stat-value">${lastRecord}</div>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button class="btn-edit" onclick="showEditForm('${device.id}', '${device.nickname || ''}')">Edit Nickname</button>
                                <button class="btn-delete-device" onclick="confirmDeleteDevice('${device.id}', ${totalRecords}, false)">Delete Device Only</button>
                                ${totalRecords > 0 ? `<button class="btn-delete-data" onclick="confirmDeleteDevice('${device.id}', ${totalRecords}, true)">Delete Device + Data</button>` : ''}
                            </div>
                            <div id="edit-form-${device.id}" class="edit-form">
                                <div class="form-group">
                                    <label>New Nickname:</label>
                                    <input type="text" id="edit-nickname-${device.id}" value="${device.nickname || ''}" placeholder="Enter nickname">
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <button onclick="updateDeviceNickname('${device.id}')" style="background: #28a745; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Save</button>
                                    <button onclick="hideEditForm('${device.id}')" style="background: #6c757d; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `);
                } catch (error) {
                    console.error(`Error loading stats for device ${device.id}:`, error);
                    deviceCards.push(`
                        <div class="device-card">
                            <div class="device-card-header">
                                <div>
                                    <div class="device-id">${device.id}</div>
                                    <div class="device-nickname">${device.nickname || 'No nickname set'}</div>
                                </div>
                            </div>
                            <div class="device-stats">
                                <div class="device-stat">
                                    <div class="device-stat-label">Status</div>
                                    <div class="device-stat-value">Error loading stats</div>
                                </div>
                            </div>
                            <div class="device-actions">
                                <button class="btn-edit" onclick="showEditForm('${device.id}', '${device.nickname || ''}')">Edit Nickname</button>
                                <button class="btn-delete-device" onclick="confirmDeleteDevice('${device.id}', 0, false)">Delete Device</button>
                            </div>
                            <div id="edit-form-${device.id}" class="edit-form">
                                <div class="form-group">
                                    <label>New Nickname:</label>
                                    <input type="text" id="edit-nickname-${device.id}" value="${device.nickname || ''}" placeholder="Enter nickname">
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <button onclick="updateDeviceNickname('${device.id}')" style="background: #28a745; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.5rem;">Save</button>
                                    <button onclick="hideEditForm('${device.id}')" style="background: #6c757d; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `);
                }
            }
            
            deviceListContainer.innerHTML = deviceCards.join('');
        } else {
            deviceListContainer.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No devices found.</p>';
        }
    } catch (error) {
        document.getElementById('device-list-container').innerHTML = '<p style="color: #dc3545;">Error loading devices</p>';
        addDebug('Failed to load device list: ' + error.message);
    }
}

function showEditForm(deviceId, currentNickname) {
    // Hide all other edit forms
    document.querySelectorAll('.edit-form').forEach(form => {
        form.classList.remove('active');
    });
    
    // Show the specific edit form
    const editForm = document.getElementById(`edit-form-${deviceId}`);
    if (editForm) {
        editForm.classList.add('active');
        document.getElementById(`edit-nickname-${deviceId}`).focus();
    }
}

function hideEditForm(deviceId) {
    const editForm = document.getElementById(`edit-form-${deviceId}`);
    if (editForm) {
        editForm.classList.remove('active');
    }
}

async function updateDeviceNickname(deviceId) {
    const nicknameInput = document.getElementById(`edit-nickname-${deviceId}`);
    const nickname = nicknameInput.value.trim();
    
    if (!nickname) {
        alert('Please enter a nickname');
        return;
    }
    
    try {
        const response = await authFetch('/nickname', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_id: deviceId, nickname: nickname })
        });
        
        if (response.ok) {
            addLog(`Updated nickname for device ${deviceId} to "${nickname}"`);
            hideEditForm(deviceId);
            await loadDeviceList();
            populateDeviceIds(); // Refresh main device selector
        } else {
            throw new Error('Failed to update nickname');
        }
    } catch (error) {
        addDebug('Failed to update device nickname: ' + error.message);
        alert('Failed to update nickname: ' + error.message);
    }
}

function confirmDeleteDevice(deviceId, recordCount, deleteData = false) {
    let message;
    if (deleteData && recordCount > 0) {
        message = `⚠️ WARNING: You are about to delete device ${deviceId} AND ALL ITS DATA!\n\n` +
                 `This will permanently delete:\n` +
                 `• Device registration and nickname\n` +
                 `• ${recordCount.toLocaleString()} data records from bike_data table\n` +
                 `• Associated records from source_data table\n\n` +
                 `THIS ACTION CANNOT BE UNDONE!\n\n` +
                 `Type "DELETE" to confirm:`;
        
        const confirmation = prompt(message);
        if (confirmation === 'DELETE') {
            deleteDevice(deviceId, true);
        }
    } else {
        message = recordCount > 0 
            ? `Are you sure you want to delete device ${deviceId}?\n\n` +
              `This will remove the device registration and nickname but will NOT delete the ${recordCount.toLocaleString()} data records.\n\n` +
              `This action cannot be undone.`
            : `Are you sure you want to delete device ${deviceId}?\n\nThis action cannot be undone.`;
        
        if (confirm(message)) {
            deleteDevice(deviceId, false);
        }
    }
}

async function deleteDevice(deviceId, deleteData = false) {
    try {
        const endpoint = deleteData ? '/device_data' : '/nickname';
        const response = await authFetch(endpoint, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_id: deviceId, delete_data: deleteData })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (deleteData && result.deleted_counts) {
                const counts = result.deleted_counts;
                let message = `Deleted device ${deviceId} and data:\n`;
                if (counts.device_registrations) message += `• Device registrations: ${counts.device_registrations}\n`;
                if (counts.bike_data_records) message += `• Bike data records: ${counts.bike_data_records}\n`;
                if (counts.source_data_records) message += `• Source data records: ${counts.source_data_records}\n`;
                addLog(message.trim());
            } else {
                addLog(`Deleted device registration for ${deviceId}`);
            }
            await loadDeviceList();
            populateDeviceIds(); // Refresh main device selector
        } else {
            throw new Error('Failed to delete device');
        }
    } catch (error) {
        addDebug('Failed to delete device: ' + error.message);
        alert('Failed to delete device: ' + error.message);
    }
}

// Records Overview Functions
function showRecordOverview() {
    hideAllForms();
    document.getElementById('records-overview').style.display = 'block';
    loadRecordOverview();
}

function hideRecordOverview() {
    document.getElementById('records-overview').style.display = 'none';
}

function refreshRecordOverview() {
    loadRecordOverview();
}

async function loadRecordOverview() {
    try {
        const overviewDiv = document.getElementById('records-overview-content');
        overviewDiv.innerHTML = 'Loading overview...';
        
        // Get all devices
        const devicesResponse = await authFetch('/device_ids');
        const devicesData = await devicesResponse.json();
        
        if (!devicesData.ids || devicesData.ids.length === 0) {
            overviewDiv.innerHTML = '<p>No devices found</p>';
            return;
        }
        
        // Get detailed statistics for each device
        const deviceStats = [];
        
        for (const device of devicesData.ids) {
            try {
                const statsResponse = await authFetch(`/device_stats?device_id=${device.id}`);
                const stats = await statsResponse.json();
                
                const totalRecords = (stats.table_counts?.bike_data || 0) + (stats.table_counts?.source_data || 0);
                
                deviceStats.push({
                    id: device.id,
                    nickname: device.nickname,
                    recordCount: totalRecords,
                    bikeDataCount: stats.table_counts?.bike_data || 0,
                    sourceDataCount: stats.table_counts?.source_data || 0,
                    avgRoughness: stats.average_roughness || 0,
                    firstRecord: stats.first_record,
                    lastRecord: stats.last_record
                });
            } catch (error) {
                console.error(`Failed to get stats for device ${device.id}:`, error);
                deviceStats.push({
                    id: device.id,
                    nickname: device.nickname,
                    recordCount: 0,
                    bikeDataCount: 0,
                    sourceDataCount: 0,
                    avgRoughness: 0,
                    firstRecord: null,
                    lastRecord: null
                });
            }
        }
        
        // Sort by record count (descending)
        deviceStats.sort((a, b) => b.recordCount - a.recordCount);
        
        // Generate overview HTML
        const totalRecords = deviceStats.reduce((sum, device) => sum + device.recordCount, 0);
        const totalBikeData = deviceStats.reduce((sum, device) => sum + device.bikeDataCount, 0);
        const totalSourceData = deviceStats.reduce((sum, device) => sum + device.sourceDataCount, 0);
        const devicesWithData = deviceStats.filter(device => device.recordCount > 0).length;
        const devicesWithoutData = deviceStats.length - devicesWithData;
        
        let html = `
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <h5 style="margin: 0 0 0.5rem 0;">Summary</h5>
                <p style="margin: 0;"><strong>Total Devices:</strong> ${deviceStats.length}</p>
                <p style="margin: 0;"><strong>Devices with Data:</strong> ${devicesWithData}</p>
                ${devicesWithoutData > 0 ? `<p style="margin: 0; color: #e67e22;"><strong>Devices without Data:</strong> ${devicesWithoutData}</p>` : ''}
                <p style="margin: 0;"><strong>Total Records:</strong> ${totalRecords.toLocaleString()}</p>
                <p style="margin: 0;"><strong>Bike Data Records:</strong> ${totalBikeData.toLocaleString()}</p>
                <p style="margin: 0;"><strong>Source Data Records:</strong> ${totalSourceData.toLocaleString()}</p>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: left;">Device</th>
                        <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">Bike Data</th>
                        <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">Source Data</th>
                        <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">Total</th>
                        <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">Avg Roughness</th>
                        <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: left;">Date Range</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        deviceStats.forEach(device => {
            const percentage = totalRecords > 0 ? ((device.recordCount / totalRecords) * 100).toFixed(1) : '0.0';
            const dateRange = device.firstRecord && device.lastRecord ? 
                `${new Date(device.firstRecord).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'})} - ${new Date(device.lastRecord).toLocaleDateString('nl-NL', {timeZone: 'Europe/Amsterdam'})}` : 
                'No data';
            
            html += `
                <tr style="${device.recordCount === 0 ? 'background-color: #fff3cd;' : ''}">
                    <td style="border: 1px solid #dee2e6; padding: 0.5rem;">
                        <strong>${device.nickname || device.id}</strong>
                        ${device.nickname ? `<br><small style="color: #666;">${device.id}</small>` : ''}
                        ${device.recordCount > 0 ? `<br><button onclick="viewDeviceData('${device.id}')" style="font-size: 0.8rem; padding: 0.2rem 0.5rem; margin-top: 0.25rem;">View Data</button>` : ''}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">
                        ${device.bikeDataCount.toLocaleString()}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">
                        ${device.sourceDataCount.toLocaleString()}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">
                        ${device.recordCount.toLocaleString()}
                        <br><small style="color: #666;">(${percentage}%)</small>
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: right;">
                        ${device.recordCount > 0 ? device.avgRoughness.toFixed(3) : 'N/A'}
                    </td>
                    <td style="border: 1px solid #dee2e6; padding: 0.5rem;">
                        <small>${dateRange}</small>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        overviewDiv.innerHTML = html;
        
    } catch (error) {
        document.getElementById('records-overview-content').innerHTML = '<p>Error loading overview</p>';
        addDebug('Failed to load record overview: ' + error.message);
    }
}

function viewDeviceData(deviceId) {
    // Close the overview modal
    hideRecordOverview();
    
    // Set the device selector to this specific device
    const deviceSelector = document.getElementById('deviceId');
    Array.from(deviceSelector.options).forEach(option => {
        option.selected = option.value === deviceId;
    });
    
    // Update selected IDs and load data
    selectedIds = [deviceId];
    setDateRange().then(loadData);
    
    addLog(`Viewing data for device: ${deviceNicknames[deviceId] || deviceId}`);
}

async function authFetch(url, options) {
    let res = await fetch(url, options);
    if (res.status === 401) {
        const pw = prompt('Password:');
        if (!pw) throw new Error('Password required');
        const loginRes = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({password: pw})
        });
        if (!loginRes.ok) throw new Error('Login failed');
        res = await fetch(url, options);
    }
    return res;
}

// Initialize page after all resources are loaded
window.addEventListener('load', async function() {
    try {
        // Ensure all collapsible sections are closed by default (except always-visible ones)
        const collapsibleSections = document.querySelectorAll('.collapsible-section');
        collapsibleSections.forEach(section => {
            const content = section.querySelector('.collapsible-content');
            if (content) {
                content.classList.remove('expanded');
                section.classList.remove('expanded');
            }
        });
        
        // Ensure Leaflet is loaded before initializing map
        if (typeof L === 'undefined') {
            console.error('Leaflet not loaded, waiting...');
            // Wait a bit and try again
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
        
        // Use centralized map initialization with map-partial
        const map = await initializeMapWithFallback({
            center: [52.028, 5.168], // Houten, NL
            zoom: 12,
            enableGeolocation: false, // Database view doesn't need geolocation
            enableBicycleMarker: false,
            enableFullscreen: true
        }, 'map-container');
        
        if (map) {
            window.map = map;
            // Initialize roughness filter
            if (typeof initializeRoughnessFilter === 'function') {
                initializeRoughnessFilter(() => {
                    loadData();
                });
            }
            
            // Initialize time range slider from map-partial
            if (typeof initializeTimeRangeSlider === 'function') {
                initializeTimeRangeSlider();
            }
            
            // Listen for time range changes from the map-partial time slider
            window.addEventListener('timeRangeChanged', (event) => {
                console.log('Time range changed in database.html:', event.detail);
                // Reload data when time range changes from slider
                loadData();
            });
            
            // Listen for general data range updates
            window.addEventListener('dataRangeUpdated', (event) => {
                console.log('Data range updated in database.html:', event.detail);
                // Update any local state if needed
                if (event.detail && event.detail.startTime !== undefined && event.detail.endTime !== undefined) {
                    window.sliderMin = event.detail.startTime;
                    window.sliderMax = event.detail.endTime;
                }
            });
        }
        
        // Initialize page regardless of map status
        populateDeviceIds();
        
        // Load device list for device management section
        await loadDeviceList();
    } catch (error) {
        console.error('Failed to initialize page:', error);
        // Fallback initialization
        populateDeviceIds();
        loadDeviceList();
    }
});

// Event listeners
document.getElementById('deviceId').addEventListener('change', () => {
    const previousIds = selectedIds.slice(); // Keep track of previous selection
    selectedIds = Array.from(document.getElementById('deviceId').selectedOptions)
        .map(o => o.value).filter(v => v);
    
    // Show loading indicator
    document.getElementById('loading').style.display = 'block';
    
    // Update time range first, then load data
    setDateRange().then(() => {
        return loadData();
    }).then(() => {
        document.getElementById('loading').style.display = 'none';
    }).catch(error => {
        document.getElementById('loading').style.display = 'none';
        console.error('Error updating device selection:', error);
        addDebug('Error updating device selection: ' + error.message);
    });
});

// Quick time range buttons - these work with the new time slider from map-partial
document.querySelectorAll('.quick-time-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const rangeType = e.target.getAttribute('data-range');
        applyQuickTimeRange(rangeType);
    });
});

// Load logs partial when DOM is ready
document.addEventListener('DOMContentLoaded', loadLogsPartial);
</script>

<!-- Include Activity Log and Debug Messages Partial -->
<div id="logs-container"></div>

</body>
</html>
