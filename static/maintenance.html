<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0 auto; padding: 1rem; max-width: 600px; }
        #page-links { margin-bottom: 1rem; }
        label { display:block; margin-top:0.5rem; }
        #log {
            width: 100%;
            height: 150px;
            overflow: auto;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
            white-space: pre;
        }
        #debug {
            width: 100%;
            height: 150px;
            margin-top: 1rem;
        }
        .log-viewer {
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 2rem;
            background: #f9f9f9;
        }
        .log-viewer-header {
            background: #e8e8e8;
            padding: 12px;
            border-bottom: 1px solid #ccc;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
        }
        .log-viewer-controls {
            padding: 12px;
            border-bottom: 1px solid #ccc;
            background: white;
        }
        .log-viewer-content {
            padding: 12px;
            background: white;
            border-radius: 0 0 6px 6px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        .control-group label {
            margin: 0;
            font-weight: bold;
            min-width: 80px;
        }
        .control-group select, .control-group input {
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .control-group button {
            padding: 6px 12px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .control-group button:hover {
            background: #005a87;
        }
        .control-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #log-display {
            width: 100%;
            height: 400px;
            overflow: auto;
            border: 1px solid #ccc;
            background: white;
            font-family: monospace;
            font-size: 0.9rem;
            padding: 8px;
            white-space: pre-wrap;
        }
        .log-entry {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        .log-entry.compact {
            padding: 4px 0;
            margin-bottom: 2px;
            border-bottom: 1px solid #f5f5f5;
        }
        .log-entry:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .log-timestamp {
            color: #666;
            font-weight: bold;
        }
        .log-level {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }
        .log-level-DEBUG { background: #e3f2fd; color: #1976d2; }
        .log-level-INFO { background: #e8f5e8; color: #2e7d32; }
        .log-level-WARNING { background: #fff3e0; color: #f57c00; }
        .log-level-ERROR { background: #ffebee; color: #d32f2f; }
        .log-level-CRITICAL { background: #f3e5f5; color: #7b1fa2; }
        .log-category {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 8px;
        }
        .log-message {
            margin-top: 4px;
        }
        .log-stack {
            margin-top: 8px;
            padding: 8px;
            background: #f5f5f5;
            border-left: 3px solid #d32f2f;
            font-family: monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }
        .log-stats {
            margin-top: 10px;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 3px;
            font-size: 0.9rem;
        }
        .api-reference {
            margin-top: 1rem;
        }
        .api-toggle {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .api-toggle:hover {
            background: #e8e8e8;
        }
        .api-content {
            display: none;
        }
        .api-content.show {
            display: block;
        }
    </style>
</head>
<body>
<h1>Maintenance</h1>
<nav id="page-links">
    <a href="/">Main</a> |
    <a href="device.html">Device View</a>
</nav>

<!-- Database Log Viewer -->
<section class="log-viewer">
    <div class="log-viewer-header">
        üìã Database Log Viewer
    </div>
    <div class="log-viewer-controls">
        <div class="control-group">
            <label>Level:</label>
            <select id="log-level-filter">
                <option value="">All Levels</option>
                <option value="DEBUG">Debug</option>
                <option value="INFO">Info</option>
                <option value="WARNING">Warning</option>
                <option value="ERROR">Error</option>
                <option value="CRITICAL">Critical</option>
            </select>
            
            <label>Category:</label>
            <select id="log-category-filter">
                <option value="">All Categories</option>
                <option value="DATABASE">Database</option>
                <option value="CONNECTION">Connection</option>
                <option value="QUERY">Query</option>
                <option value="MANAGEMENT">Management</option>
                <option value="MIGRATION">Migration</option>
                <option value="BACKUP">Backup</option>
                <option value="GENERAL">General</option>
            </select>
            
            <label>Device ID:</label>
            <input type="text" id="log-device-filter" placeholder="Filter by device ID" style="width: 120px;">
            
            <label>Limit:</label>
            <select id="log-limit">
                <option value="50">50 entries</option>
                <option value="100" selected>100 entries</option>
                <option value="200">200 entries</option>
                <option value="500">500 entries</option>
                <option value="1000">1000 entries</option>
            </select>
        </div>
        <div class="control-group">
            <label>Sort:</label>
            <select id="log-sort-order" onchange="loadDatabaseLogs()">
                <option value="desc" selected>Latest First</option>
                <option value="asc">Oldest First</option>
            </select>
            <button onclick="loadDatabaseLogs()">üîÑ Refresh Logs</button>
            <button onclick="clearLogDisplay()">üóëÔ∏è Clear Display</button>
            <button onclick="exportLogs()">üì• Export CSV</button>
            <button onclick="toggleAutoRefresh()" id="auto-refresh-btn">‚è∏Ô∏è Auto-refresh: OFF</button>
            <button onclick="repairDatabase()" style="background: #dc3545;">üîß Repair Database</button>
        </div>
    </div>
    <div class="log-viewer-content">
        <div id="log-stats" class="log-stats">
            Ready to load logs...
        </div>
        <div id="log-display">
            Click "Refresh Logs" to load database logs
        </div>
    </div>
</section>

<section class="api-reference">
    <div class="api-toggle" onclick="toggleApiReference()">
        <strong>üìñ API Reference</strong> (click to expand)
    </div>
    <div id="api-content" class="api-content">
        <table border="1" cellpadding="4" style="border-collapse:collapse;">
            <thead>
                <tr>
                    <th>Endpoint</th>
                    <th>Method</th>
                    <th>Input</th>
                    <th>Output</th>
                    <th>Auth</th>
                </tr>
            </thead>
        <tbody>
            <tr>
                <td>/login</td>
                <td>POST</td>
                <td>JSON {"password": string}</td>
                <td>204 No Content (sets auth cookie)</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/auth_check</td>
                <td>GET</td>
                <td>Auth cookie</td>
                <td>204 if valid else 401</td>
                <td>Auth cookie</td>
            </tr>
            <tr>
                <td>/log</td>
                <td>POST</td>
                <td>JSON {latitude, longitude, speed, direction, device_id, z_values[], user_agent?, device_fp?}</td>
                <td>JSON {status, roughness}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/logs?limit=N</td>
                <td>GET</td>
                <td>Query: limit=1-1000 (optional)</td>
                <td>JSON {rows: [...], average}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/filteredlogs</td>
                <td>GET</td>
                <td>Query: device_id=id[,id], start, end</td>
                <td>JSON {rows: [...], average}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/device_ids</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {ids: [{id, nickname}]}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/date_range</td>
                <td>GET</td>
                <td>Query: device_id=id[,id] (optional)</td>
                <td>JSON {start, end} ISO strings</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/nickname</td>
                <td>POST</td>
                <td>JSON {device_id, nickname}</td>
                <td>JSON {status}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/nickname?device_id=ID</td>
                <td>GET</td>
                <td>Query: device_id</td>
                <td>JSON {nickname}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/gpx?limit=N</td>
                <td>GET</td>
                <td>Query: limit=1-1000 (optional)</td>
                <td>GPX file</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/debuglog</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {log: [string]}</td>
                <td>None</td>
            </tr>
            <tr>
                <td colspan="5" style="text-align:center;font-weight:bold;">Manage Endpoints (require password)</td>
            </tr>
            <tr>
                <td>/manage/tables</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {tables}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/insert_testdata</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/delete_all?table=NAME</td>
                <td>DELETE</td>
                <td>Query: table</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/backup_table</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status, new_table}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/rename_table</td>
                <td>POST</td>
                <td>JSON {old_name, new_name}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/record?record_id=ID</td>
                <td>GET</td>
                <td>Query: record_id</td>
                <td>JSON record</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/update_record</td>
                <td>PUT</td>
                <td>JSON {id, fields...}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/delete_record?record_id=ID</td>
                <td>DELETE</td>
                <td>Query: record_id</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/merge_device_ids</td>
                <td>POST</td>
                <td>JSON {old_id, new_id}</td>
                <td>JSON {status, bike_rows}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/db_size</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {size_mb, max_size_gb}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/app_plan</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {name, sku, capacity}</td>
                <td>Password</td>
            </tr>
        </tbody>
        </table>
    </div>
</section>
<section style="margin-top:1rem;">
    <h2>Tables <button id="refresh-btn">Refresh</button></h2>
    <div id="table-list">Loading...</div>
    <pre id="table-records" style="white-space:pre;overflow:auto;margin-top:0.5rem;"></pre>
</section>
<script>
// Log viewer variables
let autoRefreshInterval = null;
let currentLogs = [];

// Utility function to format time in Dutch timezone
function formatDutchTime(isoString) {
    try {
        const date = new Date(isoString);
        return date.toLocaleString('nl-NL', {
            timeZone: 'Europe/Amsterdam',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    } catch (error) {
        return isoString; // Fallback to original string
    }
}

// Utility function to convert timestamp to CEST datetime-local format
function toCESTDateTimeLocal(timestamp) {
    try {
        const date = new Date(timestamp);
        // Convert to Europe/Amsterdam timezone
        const cesTime = new Date(date.toLocaleString('sv-SE', { timeZone: 'Europe/Amsterdam' }));
        return cesTime.toISOString().slice(0, 16);
    } catch (error) {
        // Fallback to UTC
        return new Date(timestamp).toISOString().slice(0, 16);
    }
}

// Database log viewer functions
async function loadDatabaseLogs() {
    const levelFilter = document.getElementById('log-level-filter').value;
    const categoryFilter = document.getElementById('log-category-filter').value;
    const deviceFilter = document.getElementById('log-device-filter').value;
    const limit = document.getElementById('log-limit').value;
    const sortOrder = document.getElementById('log-sort-order').value;
    try {
        // Build query parameters
        const params = new URLSearchParams();
        if (levelFilter) params.append('level_filter', levelFilter);
        if (categoryFilter) params.append('category_filter', categoryFilter);
        if (deviceFilter) params.append('device_id_filter', deviceFilter);
        if (limit) params.append('limit', limit);
        // No backend sort param, so sort client-side
        const response = await authFetch(`/manage/debug_logs?${params.toString()}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        let logs = await response.json();
        // Sort client-side
        logs.sort((a, b) => {
            const ta = new Date(a.timestamp).getTime();
            const tb = new Date(b.timestamp).getTime();
            return sortOrder === 'asc' ? ta - tb : tb - ta;
        });
        currentLogs = logs;
        displayLogs(logs);
        updateLogStats(logs);
    } catch (error) {
        document.getElementById('log-display').innerHTML = `
            <div style="color: red; padding: 10px;">
                Error loading logs: ${error.message}
            </div>
        `;
        document.getElementById('log-stats').textContent = 'Error loading logs';
    }
}

function displayLogs(logs) {
    const display = document.getElementById('log-display');
    if (!logs || logs.length === 0) {
        display.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No logs found matching the current filters</div>';
        return;
    }
    let html = '';
    logs.forEach(log => {
        const timestamp = formatDutchTime(log.timestamp);
        const level = log.level || 'INFO';
        const category = log.category || 'GENERAL';
        const deviceId = log.device_id || '';
        const message = (log.message || '').trim();
        const stackTrace = (log.stack_trace || '').trim();
        
        // Skip entries with no meaningful content
        if (!message && !stackTrace) {
            return;
        }
        
        // Compact single-line format when possible
        const hasStack = stackTrace && stackTrace.length > 0;
        const isLongMessage = message.length > 80 || message.includes('\n');
        
        if (!hasStack && !isLongMessage) {
            // Single line compact format
            html += `<div class="log-entry compact">
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-level log-level-${level}">${level}</span>
                <span class="log-category">${category}</span>
                ${deviceId ? `<span class="log-device" style="background: #e6f3ff; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">Device: ${escapeHtml(deviceId)}</span>` : ''}
                <span class="log-message-inline" style="margin-left: 8px;">${escapeHtml(message)}</span>
            </div>`;
        } else {
            // Multi-line format for complex entries
            html += `<div class="log-entry">
                <div>
                    <span class="log-timestamp">${timestamp}</span>
                    <span class="log-level log-level-${level}">${level}</span>
                    <span class="log-category">${category}</span>
                    ${deviceId ? `<span class="log-device" style="background: #e6f3ff; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">Device: ${escapeHtml(deviceId)}</span>` : ''}
                </div>
                ${message ? `<div class="log-message">${escapeHtml(message)}</div>` : ''}
                ${hasStack ? `<div class="log-stack">${escapeHtml(stackTrace)}</div>` : ''}
            </div>`;
        }
    });
    display.innerHTML = html;
}

function updateLogStats(logs) {
    if (!logs || logs.length === 0) {
        document.getElementById('log-stats').textContent = 'No logs to display';
        return;
    }
    
    const levelCounts = {};
    const categoryCounts = {};
    
    logs.forEach(log => {
        const level = log.level || 'INFO';
        const category = log.category || 'GENERAL';
        
        levelCounts[level] = (levelCounts[level] || 0) + 1;
        categoryCounts[category] = (categoryCounts[category] || 0) + 1;
    });
    
    const oldest = formatDutchTime(logs[logs.length - 1]?.timestamp);
    const newest = formatDutchTime(logs[0]?.timestamp);
    
    const levelStats = Object.entries(levelCounts)
        .map(([level, count]) => `${level}: ${count}`)
        .join(', ');
    
    const categoryStats = Object.entries(categoryCounts)
        .map(([category, count]) => `${category}: ${count}`)
        .join(', ');
    
    document.getElementById('log-stats').innerHTML = `
        <strong>Total entries:</strong> ${logs.length}<br>
        <strong>Time range:</strong> ${oldest} ‚Üí ${newest}<br>
        <strong>Levels:</strong> ${levelStats}<br>
        <strong>Categories:</strong> ${categoryStats}
    `;
}

function clearLogDisplay() {
    document.getElementById('log-display').innerHTML = 'Display cleared. Click "Refresh Logs" to reload.';
    document.getElementById('log-stats').textContent = 'Display cleared';
    currentLogs = [];
}

function exportLogs() {
    if (!currentLogs || currentLogs.length === 0) {
        alert('No logs to export. Please load logs first.');
        return;
    }
    
    const headers = ['Timestamp', 'Level', 'Category', 'Message', 'Stack Trace'];
    const csvContent = [
        headers.join(','),
        ...currentLogs.map(log => [
            `"${log.timestamp || ''}"`,
            `"${log.level || ''}"`,
            `"${log.category || ''}"`,
            `"${(log.message || '').replace(/"/g, '""')}"`,
            `"${(log.stack_trace || '').replace(/"/g, '""')}"`
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const cesTime = new Date().toLocaleString('sv-SE', { timeZone: 'Europe/Amsterdam' }).replace(/[:\s]/g, '-');
    a.download = `database_logs_${cesTime}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        btn.textContent = '‚è∏Ô∏è Auto-refresh: OFF';
        btn.style.background = '#007cba';
    } else {
        autoRefreshInterval = setInterval(loadDatabaseLogs, 10000); // Refresh every 10 seconds
        btn.textContent = '‚èØÔ∏è Auto-refresh: ON';
        btn.style.background = '#28a745';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function repairDatabase() {
    if (!confirm('This will attempt to repair database corruption issues. Continue?')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'üîß Repairing...';
    btn.disabled = true;
    
    try {
        const response = await authFetch('/manage/repair_database', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        alert(`Database repair result: ${result.message}`);
        
        // Refresh logs after repair
        loadDatabaseLogs();
        
    } catch (error) {
        alert(`Database repair failed: ${error.message}`);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// Load logs on page load
document.addEventListener('DOMContentLoaded', () => {
    loadDatabaseLogs();
    
    // Add event listeners for log filters
    document.getElementById('log-level-filter').addEventListener('change', loadDatabaseLogs);
    document.getElementById('log-category-filter').addEventListener('change', loadDatabaseLogs);
    document.getElementById('log-device-filter').addEventListener('input', debounce(loadDatabaseLogs, 300));
    document.getElementById('log-limit').addEventListener('change', loadDatabaseLogs);
});

// Debounce function to avoid too many API calls while typing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function toggleApiReference() {
    const content = document.getElementById('api-content');
    const toggle = document.querySelector('.api-toggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.innerHTML = '<strong>üìñ API Reference</strong> (click to expand)';
    } else {
        content.classList.add('show');
        toggle.innerHTML = '<strong>üìñ API Reference</strong> (click to collapse)';
    }
}

async function authFetch(url, options) {
    let res = await fetch(url, options);
    if (res.status === 401) {
        const pw = prompt('Password:');
        if (!pw) throw new Error('Password required');
        const loginRes = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({password: pw})
        });
        if (!loginRes.ok) throw new Error('Login failed');
        res = await fetch(url, options);
    }
    return res;
}

async function loadSummary() {
    const res = await authFetch('/manage/table_summary');
    const container = document.getElementById('table-list');
    if (!res.ok) { container.textContent = 'Unavailable'; return; }
    const data = await res.json();
    const tbl = document.createElement('table');
    tbl.border = '1';
    tbl.cellPadding = '4';
    const head = document.createElement('tr');
    ['Name','Rows','Last Update','Actions'].forEach(t=>{const th=document.createElement('th');th.textContent=t;head.appendChild(th);});
    tbl.appendChild(head);
    data.tables.forEach(info => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${info.name}</td><td>${info.count}</td><td>${info.last_update || ''}</td>`;
        const btnTd = document.createElement('td');
        const showBtn = document.createElement('button');
        showBtn.textContent = 'Show Last 10';
        showBtn.onclick = () => showRecords(info.name);
        btnTd.appendChild(showBtn);
        const testBtn = document.createElement('button');
        testBtn.textContent = 'Test';
        testBtn.style.marginLeft = '0.5rem';
        testBtn.onclick = () => testTable(info.name);
        btnTd.appendChild(testBtn);
        tr.appendChild(btnTd);
        tbl.appendChild(tr);
    });
    container.innerHTML = '';
    container.appendChild(tbl);
}

async function showRecords(name) {
    const res = await authFetch(`/manage/last_rows?table=${encodeURIComponent(name)}&limit=10`);
    const pre = document.getElementById('table-records');
    if (!res.ok) { pre.textContent = 'Failed to fetch records'; return; }
    const data = await res.json();
    pre.textContent = JSON.stringify(data.rows, null, 2);
}

function addLog(msg){
    const div = document.getElementById('log');
    const cesTime = new Date().toLocaleString('sv-SE', { timeZone: 'Europe/Amsterdam' });
    div.textContent += cesTime + ' - ' + msg + '\n';
    div.scrollTop = div.scrollHeight;
}

async function loadDebug(){
    const res = await authFetch('/debuglog');
    if(res.ok){
        const data = await res.json();
        const t = document.getElementById('debug');
        t.value = data.log.join('\n');
        t.scrollTop = t.scrollHeight;
    }
}

async function testTable(name){
    addLog('Testing ' + name);
    const pre = document.getElementById('table-records');
    pre.textContent = '';
    try{
        const res = await authFetch('/manage/test_table', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({table:name})
        });
        if(!res.ok){
            const text = await res.text();
            pre.textContent = text;
            addLog('Error: ' + text);
        }else{
            const data = await res.json();
            pre.textContent = JSON.stringify(data.rows, null, 2);
            addLog('Success');
        }
    }catch(e){
        pre.textContent = e.toString();
        addLog('Exception: ' + e);
    }
    loadDebug();
    loadSummary();
}

function refreshAll() {
    loadSummary();
    loadDebug();
}

loadSummary();
loadDebug();
document.getElementById('refresh-btn').addEventListener('click', refreshAll);
</script>
<section id="logs" style="margin-top:1rem;">
    <h3>Activity Log</h3>
    <div id="log"></div>
    <h3>Debug Messages</h3>
    <textarea id="debug" readonly></textarea>
</section>
</body>
</html>
