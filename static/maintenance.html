<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0 auto; padding: 1rem; max-width: 600px; }
        #page-links { margin-bottom: 1rem; }
        label { display:block; margin-top:0.5rem; }
    </style>
</head>
<body>
<h1>Maintenance</h1>
<div id="page-links">
    <a href="/">Main</a> |
    <a href="experimental.html">Experimental</a> |
    <a href="device.html">Device View</a> |
    <a href="db.html">DB Page</a>
</div>
<section>
    <h2>Database Size</h2>
    <div id="db-info">Loading...</div>
    <label>SKU <select id="db-sku" onchange="setDbSku()"></select></label>
</section>
<section style="margin-top:1rem;">
    <h2>API Reference</h2>
    <table border="1" cellpadding="4" style="border-collapse:collapse;">
        <thead>
            <tr>
                <th>Endpoint</th>
                <th>Method</th>
                <th>Input</th>
                <th>Output</th>
                <th>Auth</th>
                <th>Sample Header</th>
                <th>Sample Body</th>
                <th>Sample Response</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>/login</td>
                <td>POST</td>
                <td>JSON {password}</td>
                <td>204 No Content</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/auth_check</td>
                <td>GET</td>
                <td>Cookie</td>
                <td>204 or 401</td>
                <td>Auth cookie</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/log</td>
                <td>POST</td>
                <td>JSON {latitude, longitude, speed, direction, device_id, z_values[]}</td>
                <td>JSON {status, roughness}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/experimental_log</td>
                <td>POST</td>
                <td>Same as /log</td>
                <td>JSON {status, roughness}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/logs?limit=N</td>
                <td>GET</td>
                <td>Optional limit 1-1000</td>
                <td>JSON {rows, average}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/filteredlogs</td>
                <td>GET</td>
                <td>device_id, start, end</td>
                <td>JSON {rows, average}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/device_ids</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {ids}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/date_range</td>
                <td>GET</td>
                <td>Optional device_id</td>
                <td>JSON {start, end}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/nickname</td>
                <td>POST</td>
                <td>JSON {device_id, nickname}</td>
                <td>JSON {status}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/nickname?device_id=ID</td>
                <td>GET</td>
                <td>device_id</td>
                <td>JSON {nickname}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/gpx?limit=N</td>
                <td>GET</td>
                <td>Optional limit</td>
                <td>GPX file</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/debuglog</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {log}</td>
                <td>None</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td colspan="8" style="text-align:center;font-weight:bold;">Manage Endpoints (require password)</td>
            </tr>
            <tr>
                <td>/manage/tables</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {tables}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/insert_testdata</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/delete_all?table=NAME</td>
                <td>DELETE</td>
                <td>table</td>
                <td>JSON {status}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/backup_table</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status, new_table}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/rename_table</td>
                <td>POST</td>
                <td>JSON {old_name, new_name}</td>
                <td>JSON {status}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/record?record_id=ID</td>
                <td>GET</td>
                <td>record_id</td>
                <td>JSON record</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/update_record</td>
                <td>PUT</td>
                <td>JSON RecordUpdate</td>
                <td>JSON {status}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/delete_record?record_id=ID</td>
                <td>DELETE</td>
                <td>record_id</td>
                <td>JSON {status}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/merge_device_ids</td>
                <td>POST</td>
                <td>JSON {old_id, new_id}</td>
                <td>JSON {status, bike_rows, experimental_rows}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/db_size</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {size_mb, max_size_gb}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
            <tr>
                <td>/manage/app_plan</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {name, sku, capacity}</td>
                <td>Password</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
        </tbody>
    </table>
</section>
<section style="margin-top:1rem;">
    <h2>App Service Plan</h2>
    <div id="plan-info">Loading...</div>
</section>
<script>
async function authFetch(url, options) {
    let res = await fetch(url, options);
    if (res.status === 401) {
        const pw = prompt('Password:');
        if (!pw) throw new Error('Password required');
        const loginRes = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({password: pw})
        });
        if (!loginRes.ok) throw new Error('Login failed');
        res = await fetch(url, options);
    }
    return res;
}
async function loadDbInfo() {
    const res = await authFetch('/manage/db_size');
    if(!res.ok){ document.getElementById('db-info').textContent='Unavailable'; return; }
    const data = await res.json();
    document.getElementById('db-info').textContent = `Used: ${data.size_mb.toFixed(2)} MB, Max: ${data.max_size_gb ? data.max_size_gb.toFixed(2)+' GB' : 'unlimited'}`;
    const skuRes = await authFetch('/manage/db_sku');
    if(skuRes.ok){
        const skuData = await skuRes.json();
        const sel = document.getElementById('db-sku');
        sel.innerHTML='';
        skuData.options.forEach(o => { const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); });
        sel.value = skuData.current || '';
    }
}
async function setDbSku() {
    const sku = document.getElementById('db-sku').value;
    if(!sku) return;
    await authFetch('/manage/set_db_sku', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({sku_name: sku})
    });
    loadDbInfo();
}
async function loadPlan() {
    const res = await authFetch('/manage/app_plan');
    if(!res.ok){ document.getElementById('plan-info').textContent='Unavailable'; return; }
    const data = await res.json();
    document.getElementById('plan-info').textContent = `Name: ${data.name}, SKU: ${data.sku}, Capacity: ${data.capacity}`;
}
loadDbInfo();
loadPlan();
</script>
</body>
</html>
