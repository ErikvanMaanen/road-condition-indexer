<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0 auto; padding: 1rem; max-width: 600px; }
        #page-links { margin-bottom: 1rem; }
        label { display:block; margin-top:0.5rem; }
        #log {
            width: 100%;
            height: 150px;
            overflow: auto;
            border: 1px solid #ccc;
            margin-bottom: 1rem;
            white-space: pre;
        }
        #debug {
            width: 100%;
            height: 150px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
<h1>Maintenance</h1>
<nav id="page-links">
    <a href="/">Main</a> |
    <a href="device.html">Device View</a>
</nav>
<section>
    <h2>Database Size</h2>
    <div id="db-info">Loading...</div>
    <label>SKU <select id="db-sku" onchange="setDbSku()"></select></label>
</section>
<section style="margin-top:1rem;">
    <h2>API Reference</h2>
    <table border="1" cellpadding="4" style="border-collapse:collapse;">
        <thead>
            <tr>
                <th>Endpoint</th>
                <th>Method</th>
                <th>Input</th>
                <th>Output</th>
                <th>Auth</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>/login</td>
                <td>POST</td>
                <td>JSON {"password": string}</td>
                <td>204 No Content (sets auth cookie)</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/auth_check</td>
                <td>GET</td>
                <td>Auth cookie</td>
                <td>204 if valid else 401</td>
                <td>Auth cookie</td>
            </tr>
            <tr>
                <td>/log</td>
                <td>POST</td>
                <td>JSON {latitude, longitude, speed, direction, device_id, z_values[], user_agent?, device_fp?}</td>
                <td>JSON {status, roughness}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/logs?limit=N</td>
                <td>GET</td>
                <td>Query: limit=1-1000 (optional)</td>
                <td>JSON {rows: [...], average}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/filteredlogs</td>
                <td>GET</td>
                <td>Query: device_id=id[,id], start, end</td>
                <td>JSON {rows: [...], average}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/device_ids</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {ids: [{id, nickname}]}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/date_range</td>
                <td>GET</td>
                <td>Query: device_id=id[,id] (optional)</td>
                <td>JSON {start, end} ISO strings</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/nickname</td>
                <td>POST</td>
                <td>JSON {device_id, nickname}</td>
                <td>JSON {status}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/nickname?device_id=ID</td>
                <td>GET</td>
                <td>Query: device_id</td>
                <td>JSON {nickname}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/gpx?limit=N</td>
                <td>GET</td>
                <td>Query: limit=1-1000 (optional)</td>
                <td>GPX file</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/debuglog</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {log: [string]}</td>
                <td>None</td>
            </tr>
            <tr>
                <td colspan="5" style="text-align:center;font-weight:bold;">Manage Endpoints (require password)</td>
            </tr>
            <tr>
                <td>/manage/tables</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {tables}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/insert_testdata</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/delete_all?table=NAME</td>
                <td>DELETE</td>
                <td>Query: table</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/backup_table</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status, new_table}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/rename_table</td>
                <td>POST</td>
                <td>JSON {old_name, new_name}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/record?record_id=ID</td>
                <td>GET</td>
                <td>Query: record_id</td>
                <td>JSON record</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/update_record</td>
                <td>PUT</td>
                <td>JSON {id, fields...}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/delete_record?record_id=ID</td>
                <td>DELETE</td>
                <td>Query: record_id</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/merge_device_ids</td>
                <td>POST</td>
                <td>JSON {old_id, new_id}</td>
                <td>JSON {status, bike_rows}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/db_size</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {size_mb, max_size_gb}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/app_plan</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {name, sku, capacity}</td>
                <td>Password</td>
            </tr>
        </tbody>
    </table>
</section>
<section style="margin-top:1rem;">
    <h2>App Service Plan</h2>
    <div id="plan-info">Loading...</div>
</section>
<section style="margin-top:1rem;">
    <h2>Tables <button id="refresh-btn">Refresh</button></h2>
    <div id="table-list">Loading...</div>
    <pre id="table-records" style="white-space:pre;overflow:auto;margin-top:0.5rem;"></pre>
</section>
<script>
async function authFetch(url, options) {
    let res = await fetch(url, options);
    if (res.status === 401) {
        const pw = prompt('Password:');
        if (!pw) throw new Error('Password required');
        const loginRes = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({password: pw})
        });
        if (!loginRes.ok) throw new Error('Login failed');
        res = await fetch(url, options);
    }
    return res;
}
async function loadDbInfo() {
    const res = await authFetch('/manage/db_size');
    if(!res.ok){ document.getElementById('db-info').textContent='Unavailable'; return; }
    const data = await res.json();
    document.getElementById('db-info').textContent = `Used: ${data.size_mb.toFixed(2)} MB, Max: ${data.max_size_gb ? data.max_size_gb.toFixed(2)+' GB' : 'unlimited'}`;
    const skuRes = await authFetch('/manage/db_sku');
    if(skuRes.ok){
        const skuData = await skuRes.json();
        const sel = document.getElementById('db-sku');
        sel.innerHTML='';
        skuData.options.forEach(o => { const opt=document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); });
        sel.value = skuData.current || '';
    }
}

async function loadSummary() {
    const res = await authFetch('/manage/table_summary');
    const container = document.getElementById('table-list');
    if (!res.ok) { container.textContent = 'Unavailable'; return; }
    const data = await res.json();
    const tbl = document.createElement('table');
    tbl.border = '1';
    tbl.cellPadding = '4';
    const head = document.createElement('tr');
    ['Name','Rows','Last Update','Actions'].forEach(t=>{const th=document.createElement('th');th.textContent=t;head.appendChild(th);});
    tbl.appendChild(head);
    data.tables.forEach(info => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${info.name}</td><td>${info.count}</td><td>${info.last_update || ''}</td>`;
        const btnTd = document.createElement('td');
        const showBtn = document.createElement('button');
        showBtn.textContent = 'Show Last 10';
        showBtn.onclick = () => showRecords(info.name);
        btnTd.appendChild(showBtn);
        const testBtn = document.createElement('button');
        testBtn.textContent = 'Test';
        testBtn.style.marginLeft = '0.5rem';
        testBtn.onclick = () => testTable(info.name);
        btnTd.appendChild(testBtn);
        tr.appendChild(btnTd);
        tbl.appendChild(tr);
    });
    container.innerHTML = '';
    container.appendChild(tbl);
}

async function showRecords(name) {
    const res = await authFetch(`/manage/last_rows?table=${encodeURIComponent(name)}&limit=10`);
    const pre = document.getElementById('table-records');
    if (!res.ok) { pre.textContent = 'Failed to fetch records'; return; }
    const data = await res.json();
    pre.textContent = JSON.stringify(data.rows, null, 2);
}

function addLog(msg){
    const div = document.getElementById('log');
    div.textContent += new Date().toISOString() + ' - ' + msg + '\n';
    div.scrollTop = div.scrollHeight;
}

async function loadDebug(){
    const res = await authFetch('/debuglog');
    if(res.ok){
        const data = await res.json();
        const t = document.getElementById('debug');
        t.value = data.log.join('\n');
        t.scrollTop = t.scrollHeight;
    }
}

async function testTable(name){
    addLog('Testing ' + name);
    const pre = document.getElementById('table-records');
    pre.textContent = '';
    try{
        const res = await authFetch('/manage/test_table', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({table:name})
        });
        if(!res.ok){
            const text = await res.text();
            pre.textContent = text;
            addLog('Error: ' + text);
        }else{
            const data = await res.json();
            pre.textContent = JSON.stringify(data.rows, null, 2);
            addLog('Success');
        }
    }catch(e){
        pre.textContent = e.toString();
        addLog('Exception: ' + e);
    }
    loadDebug();
    loadSummary();
}

function refreshAll() {
    loadDbInfo();
    loadPlan();
    loadSummary();
    loadDebug();
}
async function setDbSku() {
    const sku = document.getElementById('db-sku').value;
    if(!sku) return;
    await authFetch('/manage/set_db_sku', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({sku_name: sku})
    });
    loadDbInfo();
}
async function loadPlan() {
    const res = await authFetch('/manage/app_plan');
    if(!res.ok){ document.getElementById('plan-info').textContent='Unavailable'; return; }
    const data = await res.json();
    document.getElementById('plan-info').textContent = `Name: ${data.name}, SKU: ${data.sku}, Capacity: ${data.capacity}`;
}
loadDbInfo();
loadPlan();
loadSummary();
loadDebug();
document.getElementById('refresh-btn').addEventListener('click', refreshAll);
</script>
<section id="logs" style="margin-top:1rem;">
    <h3>Activity Log</h3>
    <div id="log"></div>
    <h3>Debug Messages</h3>
    <textarea id="debug" readonly></textarea>
</section>
</body>
</html>
