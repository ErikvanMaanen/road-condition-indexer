<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0 auto; padding: 1rem; max-width: 600px; }
        #page-links { margin-bottom: 1rem; }
        label { display:block; margin-top:0.5rem; }
    </style>
</head>
<body>
<h1>Maintenance</h1>
<div id="page-links">
    <a href="/">Main</a> |
    <a href="experimental.html">Experimental</a> |
    <a href="device.html">Device View</a> |
    <a href="db.html">DB Page</a>
</div>
<section>
    <h2>Database Size</h2>
    <div id="db-info">Loading...</div>
    <label>New MAXSIZE (GB) <input id="db-size" type="number" min="1"></label>
    <button onclick="setDbSize()">Update Size</button>
</section>
<section style="margin-top:1rem;">
    <h2>API Reference</h2>
    <table border="1" cellpadding="4" style="border-collapse:collapse;">
        <thead>
            <tr>
                <th>Endpoint</th>
                <th>Method</th>
                <th>Input</th>
                <th>Output</th>
                <th>Auth</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>/login</td>
                <td>POST</td>
                <td>JSON {password}</td>
                <td>204 No Content</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/auth_check</td>
                <td>GET</td>
                <td>Cookie</td>
                <td>204 or 401</td>
                <td>Auth cookie</td>
            </tr>
            <tr>
                <td>/log</td>
                <td>POST</td>
                <td>JSON {latitude, longitude, speed, direction, device_id, z_values[]}</td>
                <td>JSON {status, roughness}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/experimental_log</td>
                <td>POST</td>
                <td>Same as /log</td>
                <td>JSON {status, roughness}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/logs?limit=N</td>
                <td>GET</td>
                <td>Optional limit 1-1000</td>
                <td>JSON {rows, average}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/filteredlogs</td>
                <td>GET</td>
                <td>device_id, start, end</td>
                <td>JSON {rows, average}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/device_ids</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {ids}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/date_range</td>
                <td>GET</td>
                <td>Optional device_id</td>
                <td>JSON {start, end}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/nickname</td>
                <td>POST</td>
                <td>JSON {device_id, nickname}</td>
                <td>JSON {status}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/nickname?device_id=ID</td>
                <td>GET</td>
                <td>device_id</td>
                <td>JSON {nickname}</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/gpx?limit=N</td>
                <td>GET</td>
                <td>Optional limit</td>
                <td>GPX file</td>
                <td>None</td>
            </tr>
            <tr>
                <td>/debuglog</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {log}</td>
                <td>None</td>
            </tr>
            <tr>
                <td colspan="5" style="text-align:center;font-weight:bold;">Manage Endpoints (require password)</td>
            </tr>
            <tr>
                <td>/manage/tables</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {tables}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/insert_testdata</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/delete_all?table=NAME</td>
                <td>DELETE</td>
                <td>table</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/backup_table</td>
                <td>POST</td>
                <td>JSON {table}</td>
                <td>JSON {status, new_table}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/rename_table</td>
                <td>POST</td>
                <td>JSON {old_name, new_name}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/record?record_id=ID</td>
                <td>GET</td>
                <td>record_id</td>
                <td>JSON record</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/update_record</td>
                <td>PUT</td>
                <td>JSON RecordUpdate</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/delete_record?record_id=ID</td>
                <td>DELETE</td>
                <td>record_id</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/merge_device_ids</td>
                <td>POST</td>
                <td>JSON {old_id, new_id}</td>
                <td>JSON {status, bike_rows, experimental_rows}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/db_size</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {size_mb, max_size_gb}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/set_db_size</td>
                <td>POST</td>
                <td>JSON {max_size_gb}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/app_plan</td>
                <td>GET</td>
                <td>None</td>
                <td>JSON {name, sku, capacity}</td>
                <td>Password</td>
            </tr>
            <tr>
                <td>/manage/set_app_plan</td>
                <td>POST</td>
                <td>JSON {sku_name?, capacity?}</td>
                <td>JSON {status}</td>
                <td>Password</td>
            </tr>
        </tbody>
    </table>
</section>
<section style="margin-top:1rem;">
    <h2>App Service Plan</h2>
    <div id="plan-info">Loading...</div>
    <label>SKU <input id="plan-sku"></label>
    <label>Capacity <input id="plan-cap" type="number" min="1"></label>
    <button onclick="setPlan()">Update Plan</button>
</section>
<script>
async function authFetch(url, options) {
    let res = await fetch(url, options);
    if (res.status === 401) {
        const pw = prompt('Password:');
        if (!pw) throw new Error('Password required');
        const loginRes = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({password: pw})
        });
        if (!loginRes.ok) throw new Error('Login failed');
        res = await fetch(url, options);
    }
    return res;
}
async function loadDbInfo() {
    const res = await authFetch('/manage/db_size');
    if(!res.ok) { document.getElementById('db-info').textContent='Unavailable'; return; }
    const data = await res.json();
    document.getElementById('db-info').textContent = `Used: ${data.size_mb.toFixed(2)} MB, Max: ${data.max_size_gb ? data.max_size_gb.toFixed(2)+' GB' : 'unlimited'}`;
}
async function setDbSize() {
    const val = document.getElementById('db-size').value;
    if(!val) return;
    await authFetch('/manage/set_db_size', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({max_size_gb: parseInt(val,10)})
    });
    loadDbInfo();
}
async function loadPlan() {
    const res = await authFetch('/manage/app_plan');
    if(!res.ok){ document.getElementById('plan-info').textContent='Unavailable'; return; }
    const data = await res.json();
    document.getElementById('plan-info').textContent = `Name: ${data.name}, SKU: ${data.sku}, Capacity: ${data.capacity}`;
}
async function setPlan() {
    const sku = document.getElementById('plan-sku').value.trim();
    const cap = parseInt(document.getElementById('plan-cap').value,10);
    if(!sku && !cap) return;
    const body = {};
    if(sku) body.sku_name = sku;
    if(cap) body.capacity = cap;
    await authFetch('/manage/set_app_plan', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
    });
    loadPlan();
}
loadDbInfo();
loadPlan();
</script>
</body>
</html>
