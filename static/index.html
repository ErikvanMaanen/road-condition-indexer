<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Road Condition Indexer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; }
        #log, #records { width: 100%; height: 150px; overflow: auto; border: 1px solid #ccc; margin-bottom: 1rem; white-space: pre; }
        #debug { width: 100%; height: 150px; margin-top: 1rem; }
        #map { width: 100%; height: 400px; margin-bottom: 1rem; }
    </style>
</head>
<body>
<h1>Road Condition Indexer</h1>
<div id="log"></div>
<pre id="records"></pre>
<div id="map"></div>
<textarea id="debug" readonly></textarea>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let zValues = [];
let map;

function initMap() {
    // Start slightly zoomed out so a larger area is visible
    map = L.map('map').setView([0, 0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
}

function addLog(msg) {
    const div = document.getElementById('log');
    div.textContent += msg + '\n';
    div.scrollTop = div.scrollHeight;
}

function colorForRoughness(r) {
    const ratio = Math.min(Math.max(r / 10, 0), 1);
    const red = Math.floor(255 * ratio);
    const green = Math.floor(255 * (1 - ratio));
    return `rgb(${red},${green},0)`;
}

function loadLogs() {
    fetch('/logs').then(r => r.json()).then(data => {
        const recordEl = document.getElementById('records');
        recordEl.textContent = '';
        if (map) {
            map.eachLayer(layer => {
                if (layer instanceof L.CircleMarker) {
                    map.removeLayer(layer);
                }
            });
        }
        data.reverse().forEach(row => {
            const { latitude, longitude, roughness, timestamp } = row;
            const timeStr = new Date(timestamp).toLocaleString();
            recordEl.textContent += `${timeStr} - ${latitude}, ${longitude} - roughness ${roughness.toFixed(2)}\n`;
            if (map) {
                L.circleMarker([latitude, longitude], {
                    radius: 6,
                    color: colorForRoughness(roughness),
                    fillColor: colorForRoughness(roughness),
                    fillOpacity: 0.8
                }).addTo(map);
            }
        });
    }).catch(err => console.error(err)).finally(() => setTimeout(loadLogs, 10000));
}

function addDebug(msg) {
    const el = document.getElementById('debug');
    el.value += msg + '\n';
    el.scrollTop = el.scrollHeight;
}

if (window.DeviceMotionEvent) {
    window.addEventListener('devicemotion', (event) => {
        if (event.accelerationIncludingGravity) {
            zValues.push(event.accelerationIncludingGravity.z || 0);
        }
    });
}

if (navigator.geolocation) {
    navigator.geolocation.watchPosition((pos) => {
        const { latitude, longitude, speed, heading } = pos.coords;
        addLog(`Location: ${latitude}, ${longitude} speed: ${speed}`);
        if (zValues.length > 0) {
            fetch('/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    latitude,
                    longitude,
                    speed: speed || 0,
                    direction: heading || 0,
                    z_values: zValues
                })
            }).then(r => r.json()).then(data => {
                if (data.roughness !== undefined) {
                    addLog('Roughness: ' + data.roughness.toFixed(2));
                }
            }).catch(err => addDebug('Error: ' + err));
            zValues = [];
        }
    }, err => addDebug('Geolocation error: ' + err.message));
}

function pollDebug() {
    fetch('/debuglog').then(r => r.json()).then(data => {
        document.getElementById('debug').value = data.log.join('\n');
    }).catch(console.error).finally(() => setTimeout(pollDebug, 2000));
}

initMap();
loadLogs();
pollDebug();
</script>
</body>
</html>
