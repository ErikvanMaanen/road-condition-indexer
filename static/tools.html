<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="/static/utils.js"></script>
    <link rel="stylesheet" href="/static/vendor/datatables/jquery.dataTables.min.css">
    <script src="/static/vendor/jquery/jquery-3.7.1.min.js"></script>
    <script src="/static/vendor/datatables/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@10.0.3/dist/jsoneditor.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@10.0.3/dist/jsoneditor.min.js"></script>
    <link rel="stylesheet" href="/static/lib/simple-json-diff.css">
    <script src="/static/lib/simple-json-diff.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0 auto; padding: 1rem; max-width: 1000px; }
        #page-links { margin-bottom: 1rem; }
        .section { border: 1px solid #ddd; border-radius: 4px; margin: 20px 0; background: #f9f9f9; }
        .section-header { padding: 8px 12px; background: #e9e9e9; border-bottom: 1px solid #ddd; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; color: #007cba; }
        .section-header:hover { background: #ddd; }
        .section-content { padding: 12px; display: none; }
        .section-toggle { font-family: monospace; font-size: 1.2em; }
        #drop-zone { border: 2px dashed #007cba; padding: 20px; text-align: center; border-radius: 4px; margin-bottom: 10px; }
        #drop-zone.hover { background: #e0f0ff; }
        #file-input { margin-top: 10px; }
        #json-drop-zone { border: 2px dashed #007cba; padding: 20px; text-align: center; border-radius: 4px; margin-bottom: 10px; }
        #json-drop-zone.hover { background: #e0f0ff; }
        #json-editor { border: 1px solid #ddd; border-radius: 4px; height: 420px; margin-top: 10px; }
        .compare-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start; }
        .json-col { display: flex; flex-direction: column; }
        .json-col h4 { margin: 0 0 .25rem 0; color:#495057; }
        .json-drop { border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 8px 0; border-radius: 4px; color: #666; }
        .json-drop.hover { border-color: #007cba; background: #f0f8ff; }
        .side-by-side { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .diff-panel { border: 1px solid #ddd; border-radius: 4px; padding: 10px; }
        .diff-header { font-weight: bold; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; }
        .diff-controls { margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        .diff-controls label { display: flex; align-items: center; font-size: 0.9em; }
        .diff-content { font-family: 'Courier New', monospace; font-size: 0.9em; }
        .json-drop { border: 2px dashed #007cba; padding: 12px; text-align:center; border-radius: 4px; margin-bottom: 8px; }
        .json-drop.hover { background:#e0f0ff; }
        .result-box { margin-top: 10px; border:1px solid #ddd; border-radius:4px; padding:10px; background:#fff; overflow:auto; max-height:480px; }
        .mode-group label { margin-right: .75rem; }
        .side-by-side { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .diff-panel { border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
        .diff-header { background: #f8f9fa; padding: 8px 12px; font-weight: bold; border-bottom: 1px solid #ddd; }
        .diff-content { padding: 12px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.4; }
        .diff-controls { padding: 8px 12px; background: #fff; border-bottom: 1px solid #ddd; display: flex; gap: 1rem; align-items: center; }
        .diff-controls label { display: flex; align-items: center; gap: 0.25rem; font-size: 0.9em; cursor: pointer; }
        .json-object { margin-left: 0; }
        .json-property { margin: 2px 0; padding: 2px 4px; border-radius: 2px; }
        .json-key { font-weight: bold; color: #007cba; }
        .json-value { margin-left: 0.5em; }
        .json-string { color: #28a745; }
        .json-number { color: #dc3545; }
        .json-boolean { color: #6f42c1; }
        .json-null { color: #6c757d; font-style: italic; }
        .json-array, .json-nested-object { margin-left: 1em; }
        .json-bracket { color: #666; font-weight: bold; }
        .json-expand { cursor: pointer; user-select: none; color: #007cba; font-weight: bold; margin-right: 0.25em; }
        .json-expand:hover { background: #e0f0ff; }
        .diff-added { background-color: #d4edda; border-left: 3px solid #28a745; }
        .diff-removed { background-color: #f8d7da; border-left: 3px solid #dc3545; }
        .diff-modified { background-color: #fff3cd; border-left: 3px solid #ffc107; }
        .diff-unchanged { background-color: #f8f9fa; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav id="page-links">
    <a href="/">Main</a> |
    <a href="device.html">Device View</a> |
    <a href="database.html">Database Management</a> |
    <a href="maintenance.html">Maintenance</a> |
    <a href="shared.html">Shared</a>
</nav>

<h1><img src="/static/logo.png" alt="Road Condition Indexer Logo" style="height: 2em; vertical-align: middle; margin-right: 0.5em;">Tools</h1>

<!-- Calendar Viewer Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('cal-viewer')">
        <span>üìÖ Calendar Viewer</span>
        <span class="section-toggle" id="cal-viewer-toggle">‚ñ∂</span>
    </div>
    <div class="section-content" id="cal-viewer-content">
        <div id="drop-zone">
            Drag & drop .cal/.ics files here or
            <br>
            <input type="file" id="file-input" accept=".cal,.ics" multiple>
            <br>
            <button id="open-btn" disabled>Open</button>
            <div id="file-list" style="margin-top:8px; font-size:0.9em; color:#555;"></div>
        </div>
    <div id="calendar-table"></div>
    </div>
</div>

<!-- String to ASCII Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('string-ascii')">
        <span>üî° String to ASCII</span>
        <span class="section-toggle" id="string-ascii-toggle">‚ñ∂</span>
    </div>
    <div class="section-content" id="string-ascii-content">
        <textarea id="ascii-input" rows="3" style="width:100%;" placeholder="Enter text here"></textarea><br>
        <button id="ascii-convert-btn">Convert</button>
        <table id="ascii-table" class="display" style="width:100%; margin-top:1em;">
            <thead><tr><th>Character</th><th>ASCII Code</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- JSON Editor Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('json-editor')">
        <span>üß© JSON Editor</span>
        <span class="section-toggle" id="json-editor-toggle">‚ñ∂</span>
    </div>
    <div class="section-content" id="json-editor-content">
        <div id="json-drop-zone">
            Drag & drop a .json file here or paste JSON below
        </div>
        <div style="margin:6px 0;">
            <input type="file" id="json-file-input" accept=".json,application/json">
            <span id="json-file-name" style="font-size:0.9em;color:#555;margin-left:6px;"></span>
        </div>
        <textarea id="json-text" rows="8" style="width:100%;" placeholder='Paste JSON here...'></textarea>
        <div style="margin-top:8px; display:flex; gap:.5rem; flex-wrap:wrap;">
            <button id="json-load-btn">Load JSON</button>
            <button id="json-download-btn" disabled>Download Edited JSON</button>
            <button id="json-clear-btn">Clear</button>
        </div>
        <div id="json-editor"></div>
    </div>
</div>

<!-- JSON Compare Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('json-compare')">
        <span>üîç JSON Compare</span>
        <span class="section-toggle" id="json-compare-toggle">‚ñ∂</span>
    </div>
    <div class="section-content" id="json-compare-content">
        <div class="compare-grid">
            <div class="json-col">
                <h4>JSON A</h4>
                <div id="jsonA-drop" class="json-drop">Drag & drop file A here</div>
                <div style="margin:6px 0;">
                    <input type="file" id="jsonA-file" accept=".json,application/json">
                    <span id="jsonA-name" style="font-size:0.9em;color:#555;margin-left:6px;"></span>
                </div>
                <textarea id="jsonA-text" rows="10" style="width:100%;" placeholder='Paste JSON A here...'></textarea>
            </div>
            <div class="json-col">
                <h4>JSON B</h4>
                <div id="jsonB-drop" class="json-drop">Drag & drop file B here</div>
                <div style="margin:6px 0;">
                    <input type="file" id="jsonB-file" accept=".json,application/json">
                    <span id="jsonB-name" style="font-size:0.9em;color:#555;margin-left:6px;"></span>
                </div>
                <textarea id="jsonB-text" rows="10" style="width:100%;" placeholder='Paste JSON B here...'></textarea>
            </div>
        </div>
        <div style="margin-top:8px; display:flex; gap:.75rem; align-items:center; flex-wrap:wrap;" class="mode-group">
            <label><input type="radio" name="compare-mode" value="differences" checked> Differences</label>
            <label><input type="radio" name="compare-mode" value="similarities"> Similarities</label>
            <button id="json-compare-btn">Compare</button>
        </div>
        <div id="json-compare-result" class="result-box jsondiffpatch-visualdiff"></div>
    </div>
</div>

<!-- Video Downloader Section -->
<div class="section">
    <div class="section-header" onclick="toggleSection('video-downloader')">
        <span>üé• Video Downloader</span>
        <span class="section-toggle" id="video-downloader-toggle">‚ñ∂</span>
    </div>
    <div class="section-content" id="video-downloader-content">
        <div id="video-drop" class="json-drop">Drop or paste a video URL here</div>
        <div style="margin:6px 0;">
            <input type="text" id="video-url" style="width:100%;" placeholder="Enter video URL here">
        </div>
        <button id="video-download-btn" disabled>Download</button>
        <a id="video-download-link" style="display:none;"></a>
        <div id="video-status" style="margin-top:8px;font-size:0.9em;color:#555;"></div>
    </div>
</div>





<script>
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const toggle = document.getElementById(sectionId + '-toggle');
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

let selectedFiles = [];
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const openBtn = document.getElementById('open-btn');
const fileListEl = document.getElementById('file-list');

function fileKey(f) { return `${f.name}|${f.size}|${f.lastModified}`; }
function updateFileListUI() {
    if (!fileListEl) return;
    if (!selectedFiles.length) {
        fileListEl.textContent = 'No files selected.';
    } else {
        const names = selectedFiles.map(f => f.name).join(', ');
        fileListEl.textContent = `${selectedFiles.length} file(s): ${names}`;
    }
    openBtn.disabled = selectedFiles.length === 0;
}
function addFiles(files) {
    const existing = new Set(selectedFiles.map(fileKey));
    Array.from(files).forEach(f => {
        const ext = (f.name.split('.').pop() || '').toLowerCase();
        if (!['cal','ics'].includes(ext)) return;
        if (!existing.has(fileKey(f))) {
            selectedFiles.push(f);
            existing.add(fileKey(f));
        }
    });
    updateFileListUI();
}

['dragenter','dragover'].forEach(name => {
    dropZone.addEventListener(name, e => { e.preventDefault(); dropZone.classList.add('hover'); });
});
['dragleave','drop'].forEach(name => {
    dropZone.addEventListener(name, e => { e.preventDefault(); dropZone.classList.remove('hover'); });
});
dropZone.addEventListener('drop', e => {
    addFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', e => {
    addFiles(e.target.files);
    // clear the input so the same file can be selected again if needed
    e.target.value = '';
});

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

openBtn.addEventListener('click', async () => {
    if (!selectedFiles.length) return;
    try {
        const texts = await Promise.all(selectedFiles.map(readFileAsText));
        // Merge all events from all files into one overview
        const allEvents = [];
        texts.forEach(t => { allEvents.push(...parseICS(t)); });
        renderTable(allEvents);
    } catch (err) {
        console.error('Failed to read files:', err);
        alert('Failed to read one or more files.');
    }
});

function parseICS(text) {
    const lines = text.split(/\r?\n/);
    const events = [];
    let event = null;
    lines.forEach(line => {
        if (line === 'BEGIN:VEVENT') {
            event = {};
        } else if (line === 'END:VEVENT') {
            if (event) events.push(event);
            event = null;
        } else if (event) {
            const [key, ...valueParts] = line.split(':');
            const value = valueParts.join(':');
            if (key.startsWith('DTSTART')) event.dtstart = value;
            else if (key.startsWith('DTEND')) event.dtend = value;
            else if (key === 'SUMMARY') event.summary = value;
            else if (key === 'NAME') event.name = value;
            else if (key === 'LOCATION') event.location = value;
            else if (key === 'STATUS') event.status = value;
            else if (key.startsWith('DTSTAMP')) event.dtstamp = value;
        }
    });
    return events;
}

function formatDate(str) {
    if (!str) return '';
    let s = str.trim();
    if (s.length >= 8 && !s.includes('-')) {
        const yyyy = s.slice(0,4);
        const mm = s.slice(4,6);
        const dd = s.slice(6,8);
        if (s.length > 8) {
            const hh = s.slice(9,11);
            const mi = s.slice(11,13);
            const ss = s.slice(13,15);
            const dt = new Date(Date.UTC(yyyy, mm-1, dd, hh, mi, ss));
            return dt.toLocaleString();
        }
        return new Date(`${yyyy}-${mm}-${dd}`).toLocaleDateString();
    }
    return s;
}

function renderTable(events) {
    const container = document.getElementById('calendar-table');
    if (!events.length) {
        container.innerHTML = '<p>No events found.</p>';
        return;
    }
    let html = '<table id="events-table" class="display"><thead><tr><th>DTSTART</th><th>DTEND</th><th>SUMMARY</th><th>location</th><th>status</th><th>DTSTAMP</th></tr></thead><tbody>';
    events.forEach(ev => {
        html += `<tr><td>${formatDate(ev.dtstart)}</td><td>${formatDate(ev.dtend)}</td><td>${ev.summary || ''}</td><td>${ev.location || ''}</td><td>${ev.status || ''}</td><td>${formatDate(ev.dtstamp)}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
    $('#events-table').DataTable();
}

// String to ASCII conversion
const asciiInput = document.getElementById('ascii-input');
const asciiBtn = document.getElementById('ascii-convert-btn');
const asciiTableBody = document.querySelector('#ascii-table tbody');

asciiBtn.addEventListener('click', () => {
    const text = asciiInput.value || '';
    let rows = '';
    for (const ch of text) {
        let displayChar = ch;
        if (ch === ' ') displayChar = '&nbsp;';
        else if (ch === '\n') displayChar = '\\n';
        else if (ch === '\r') displayChar = '\\r';
        rows += `<tr><td>${displayChar}</td><td>${ch.charCodeAt(0)}</td></tr>`;
    }
    asciiTableBody.innerHTML = rows || '<tr><td colspan="2">No input</td></tr>';
    if ($.fn.DataTable.isDataTable('#ascii-table')) {
        $('#ascii-table').DataTable().destroy();
    }
    $('#ascii-table').DataTable();
});

// JSON Editor tool
let jsonEditor = null;
const jsonDropZone = document.getElementById('json-drop-zone');
const jsonText = document.getElementById('json-text');
const jsonLoadBtn = document.getElementById('json-load-btn');
const jsonDownloadBtn = document.getElementById('json-download-btn');
const jsonClearBtn = document.getElementById('json-clear-btn');
const jsonEditorContainer = document.getElementById('json-editor');
const jsonFileInput = document.getElementById('json-file-input');
const jsonFileName = document.getElementById('json-file-name');

// Handle file selection via input
jsonFileInput.addEventListener('change', e => {
    const file = e.target.files && e.target.files[0];
    if (!file) { jsonFileName.textContent = ''; return; }
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (ext !== 'json') { alert('Please select a .json file.'); e.target.value=''; return; }
    jsonFileName.textContent = file.name;
    const reader = new FileReader();
    reader.onload = ev => { jsonText.value = ev.target.result || ''; };
    reader.onerror = () => alert('Failed to read file.');
    reader.readAsText(file);
});

['dragenter','dragover'].forEach(name => {
    jsonDropZone.addEventListener(name, e => { e.preventDefault(); jsonDropZone.classList.add('hover'); });
});
['dragleave','drop'].forEach(name => {
    jsonDropZone.addEventListener(name, e => { e.preventDefault(); jsonDropZone.classList.remove('hover'); });
});
jsonDropZone.addEventListener('drop', e => {
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (ext !== 'json') return;
    const reader = new FileReader();
    reader.onload = ev => { jsonText.value = ev.target.result || ''; };
    reader.readAsText(file);
});

function ensureJsonEditor() {
    if (!jsonEditor) {
        jsonEditor = new JSONEditor(jsonEditorContainer, {
            mode: 'tree',
            modes: ['tree','code'],
            navigationBar: true,
            mainMenuBar: true,
            statusBar: false,
            onError: function (err) { alert(err.toString()); }
        });
    }
}

jsonLoadBtn.addEventListener('click', () => {
    const text = jsonText.value.trim();
    if (!text) { alert('Please paste JSON or drop a file first.'); return; }
    try {
        const obj = JSON.parse(text);
        ensureJsonEditor();
        jsonEditor.set(obj);
        // collapse all nodes initially
        setTimeout(() => { try { jsonEditor.collapseAll(); } catch(_){} }, 0);
        jsonDownloadBtn.disabled = false;
    } catch (e) {
        console.error('Invalid JSON:', e);
        alert('Invalid JSON: ' + e.message);
    }
});

jsonDownloadBtn.addEventListener('click', () => {
    try {
        const obj = jsonEditor ? jsonEditor.get() : JSON.parse(jsonText.value || '{}');
        const content = JSON.stringify(obj, null, 2);
        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g, '-');
        a.download = `edited-${ts}.json`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (e) {
        alert('Unable to generate download: ' + e.message);
    }
});

jsonClearBtn.addEventListener('click', () => {
    jsonText.value = '';
    if (jsonEditor) { try { jsonEditor.set({}); jsonEditor.collapseAll(); } catch(_){} }
    jsonDownloadBtn.disabled = true;
});

// JSON Compare tool
const jsonAFile = document.getElementById('jsonA-file');
const jsonBFile = document.getElementById('jsonB-file');
const jsonAName = document.getElementById('jsonA-name');
const jsonBName = document.getElementById('jsonB-name');
const jsonADrop = document.getElementById('jsonA-drop');
const jsonBDrop = document.getElementById('jsonB-drop');
const jsonAText = document.getElementById('jsonA-text');
const jsonBText = document.getElementById('jsonB-text');
const jsonCompareBtn = document.getElementById('json-compare-btn');
const jsonCompareResult = document.getElementById('json-compare-result');

function readFileInto(file, targetTextArea, nameEl) {
    if (!file) { if (nameEl) nameEl.textContent=''; return; }
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (ext !== 'json') { alert('Please select a .json file.'); return; }
    if (nameEl) nameEl.textContent = file.name;
    const reader = new FileReader();
    reader.onload = ev => { targetTextArea.value = ev.target.result || ''; };
    reader.onerror = () => alert('Failed to read file.');
    reader.readAsText(file);
}

jsonAFile.addEventListener('change', e => readFileInto(e.target.files && e.target.files[0], jsonAText, jsonAName));
jsonBFile.addEventListener('change', e => readFileInto(e.target.files && e.target.files[0], jsonBText, jsonBName));

;['dragenter','dragover'].forEach(evt => {
    [jsonADrop, jsonBDrop].forEach(el => el.addEventListener(evt, e => { e.preventDefault(); el.classList.add('hover'); }));
});
;['dragleave','drop'].forEach(evt => {
    [jsonADrop, jsonBDrop].forEach(el => el.addEventListener(evt, e => { e.preventDefault(); el.classList.remove('hover'); }));
});
jsonADrop.addEventListener('drop', e => readFileInto(e.dataTransfer.files && e.dataTransfer.files[0], jsonAText, jsonAName));
jsonBDrop.addEventListener('drop', e => readFileInto(e.dataTransfer.files && e.dataTransfer.files[0], jsonBText, jsonBName));

jsonCompareBtn.addEventListener('click', () => {
    jsonCompareResult.innerHTML = '';
    const mode = (document.querySelector('input[name="compare-mode"]:checked') || {}).value || 'differences';
    const aText = jsonAText.value.trim();
    const bText = jsonBText.value.trim();
    
    if (!aText || !bText) { 
        alert('Please provide both JSON A and JSON B (paste, drop, or choose files).'); 
        return; 
    }
    
    const parseA = parseJsonSafe(aText, 'JSON A');
    const parseB = parseJsonSafe(bText, 'JSON B');
    
    if (!parseA.ok) { alert(parseA.error); return; }
    if (!parseB.ok) { alert(parseB.error); return; }
    
    if (mode === 'similarities') {
        computeAndDisplaySimilarities(parseA.value, parseB.value);
    } else {
        computeAndDisplayDifferences(parseA.value, parseB.value);
    }
});

function parseJsonSafe(text, which) {
    try {
        return { ok: true, value: JSON.parse(text) };
    } catch (e) {
        return { ok: false, error: `Invalid JSON in ${which}: ${e.message}` };
    }
}

function computeSimilarities(a, b) {
    if (typeof a !== typeof b) return undefined;
    if (a === null || b === null) return a === b ? a : undefined;
    if (Array.isArray(a) && Array.isArray(b)) {
        const len = Math.min(a.length, b.length);
        const res = [];
        for (let i = 0; i < len; i++) {
            const child = computeSimilarities(a[i], b[i]);
            if (child !== undefined) res[i] = child;
        }
        // keep only indices that matched
        return res.filter(v => v !== undefined).length ? res : [];
    }
    if (typeof a === 'object') {
        const keys = Object.keys(a);
        const out = {};
        keys.forEach(k => {
            if (Object.prototype.hasOwnProperty.call(b, k)) {
                const child = computeSimilarities(a[k], b[k]);
                if (child !== undefined) {
                    if (typeof child === 'object') {
                        const isArray = Array.isArray(child);
                        const hasItems = isArray ? child.length > 0 : Object.keys(child).length > 0;
                        if (hasItems) out[k] = child;
                    } else {
                        out[k] = child;
                    }
                }
            }
        });
        return Object.keys(out).length ? out : {};
    }
    return a === b ? a : undefined;
}

function computeAndDisplayDifferences(objA, objB) {
    try {
        const diffResult = computeObjectDifferences(objA, objB);
        displayStructuredDiff(diffResult, 'JSON A', 'JSON B', 'differences');
    } catch (error) {
        console.error('Difference computation error:', error);
        alert('Failed to compute differences: ' + error.message);
    }
}

function computeObjectDifferences(objA, objB, path = '') {
    const result = {
        added: [],
        removed: [],
        modified: [],
        unchanged: []
    };
    
    const processedKeys = new Set();
    
    // Process all keys from both objects
    const allKeys = new Set([
        ...Object.keys(objA || {}),
        ...Object.keys(objB || {})
    ]);
    
    allKeys.forEach(key => {
        const currentPath = path ? `${path}.${key}` : key;
        const valueA = objA && objA.hasOwnProperty(key) ? objA[key] : undefined;
        const valueB = objB && objB.hasOwnProperty(key) ? objB[key] : undefined;
        
        if (valueA === undefined && valueB !== undefined) {
            result.added.push({ path: currentPath, key, value: valueB, type: getValueType(valueB) });
        } else if (valueA !== undefined && valueB === undefined) {
            result.removed.push({ path: currentPath, key, value: valueA, type: getValueType(valueA) });
        } else if (valueA !== undefined && valueB !== undefined) {
            if (deepEqual(valueA, valueB)) {
                result.unchanged.push({ path: currentPath, key, value: valueA, type: getValueType(valueA) });
            } else {
                if (isObject(valueA) && isObject(valueB)) {
                    const nestedDiff = computeObjectDifferences(valueA, valueB, currentPath);
                    result.modified.push({ 
                        path: currentPath, 
                        key, 
                        valueA, 
                        valueB, 
                        type: 'object',
                        nested: nestedDiff 
                    });
                } else {
                    result.modified.push({ 
                        path: currentPath, 
                        key, 
                        valueA, 
                        valueB, 
                        typeA: getValueType(valueA),
                        typeB: getValueType(valueB)
                    });
                }
            }
        }
        
        processedKeys.add(key);
    });
    
    return result;
}

function computeAndDisplaySimilarities(objA, objB) {
    try {
        const diffResult = computeObjectDifferences(objA, objB);
        displayStructuredDiff(diffResult, 'JSON A (Common)', 'JSON B (Common)', 'similarities');
    } catch (error) {
        console.error('Similarities computation error:', error);
        alert('Failed to compute similarities: ' + error.message);
    }
}

function displayStructuredDiff(diffResult, leftTitle, rightTitle, mode) {
    const leftPanel = createStructuredDiffPanel(diffResult, leftTitle, 'left', mode);
    const rightPanel = createStructuredDiffPanel(diffResult, rightTitle, 'right', mode);
    
    jsonCompareResult.innerHTML = `
        <div class="side-by-side">
            ${leftPanel}
            ${rightPanel}
        </div>
    `;
    
    // Add event listeners for expand/collapse and visibility controls
    setupDiffControls();
}

function createStructuredDiffPanel(diffResult, title, side, mode) {
    const controls = `
        <div class="diff-controls">
            <label><input type="checkbox" class="toggle-unchanged" checked> Show Unchanged</label>
            <label><input type="checkbox" class="toggle-modified" checked> Show Modified</label>
            <label><input type="checkbox" class="toggle-added" checked> Show Added</label>
            <label><input type="checkbox" class="toggle-removed" checked> Show Removed</label>
        </div>
    `;
    
    const content = renderDiffContent(diffResult, side, mode);
    
    return `
        <div class="diff-panel">
            <div class="diff-header">${title}</div>
            ${controls}
            <div class="diff-content">${content}</div>
        </div>
    `;
}

function renderDiffContent(diffResult, side, mode) {
    let html = '<div class="json-object">';
    
    // Render in order: unchanged, modified, added, removed
    const sections = [
        { items: diffResult.unchanged, type: 'unchanged', label: 'Unchanged' },
        { items: diffResult.modified, type: 'modified', label: 'Modified' },
        { items: diffResult.added, type: 'added', label: 'Added' },
        { items: diffResult.removed, type: 'removed', label: 'Removed' }
    ];
    
    sections.forEach(section => {
        if (section.items.length > 0) {
            section.items.forEach(item => {
                html += renderDiffItem(item, section.type, side);
            });
        }
    });
    
    html += '</div>';
    return html;
}

function renderDiffItem(item, diffType, side) {
    const cssClass = `diff-${diffType}`;
    let content = '';
    
    if (diffType === 'modified' && item.nested) {
        // Nested object modification
        const expandId = `expand-${generateId()}`;
        content = `
            <div class="json-property ${cssClass}">
                <span class="json-expand" onclick="toggleExpand('${expandId}')">‚ñ∂</span>
                <span class="json-key">"${item.key}"</span>: 
                <span class="json-bracket">{</span>
                <div id="${expandId}" class="json-nested-object hidden">
                    ${renderDiffContent(item.nested, side, 'differences')}
                </div>
                <span class="json-bracket">}</span>
            </div>
        `;
    } else if (diffType === 'modified') {
        // Simple value modification
        const value = side === 'left' ? item.valueA : item.valueB;
        content = `
            <div class="json-property ${cssClass}">
                <span class="json-key">"${item.key}"</span>: ${formatValue(value)}
            </div>
        `;
    } else {
        // Added, removed, or unchanged
        content = `
            <div class="json-property ${cssClass}">
                <span class="json-key">"${item.key}"</span>: ${formatValue(item.value)}
            </div>
        `;
    }
    
    return content;
}

function formatValue(value) {
    if (value === null) {
        return '<span class="json-null">null</span>';
    }
    
    const type = typeof value;
    
    if (type === 'string') {
        return `<span class="json-string">"${escapeHtml(value)}"</span>`;
    } else if (type === 'number') {
        return `<span class="json-number">${value}</span>`;
    } else if (type === 'boolean') {
        return `<span class="json-boolean">${value}</span>`;
    } else if (Array.isArray(value)) {
        const expandId = `expand-${generateId()}`;
        const preview = value.length <= 3 ? 
            `[${value.map(formatValue).join(', ')}]` : 
            `[${value.slice(0, 2).map(formatValue).join(', ')}, ... (+${value.length - 2} more)]`;
        
        return `
            <span class="json-expand" onclick="toggleExpand('${expandId}')">‚ñ∂</span>
            <span class="json-bracket">[</span>
            <span id="${expandId}-preview">${preview}</span>
            <div id="${expandId}" class="json-array hidden">
                ${value.map((item, index) => `<div class="json-property"><span class="json-key">[${index}]</span>: ${formatValue(item)}</div>`).join('')}
            </div>
            <span class="json-bracket">]</span>
        `;
    } else if (type === 'object') {
        const expandId = `expand-${generateId()}`;
        const keys = Object.keys(value);
        const preview = keys.length <= 2 ? 
            `{${keys.map(k => `"${k}": ${formatValue(value[k])}`).join(', ')}}` :
            `{"${keys[0]}": ${formatValue(value[keys[0]])}, ... (+${keys.length - 1} more)}`;
        
        return `
            <span class="json-expand" onclick="toggleExpand('${expandId}')">‚ñ∂</span>
            <span class="json-bracket">{</span>
            <span id="${expandId}-preview">${preview}</span>
            <div id="${expandId}" class="json-nested-object hidden">
                ${keys.map(k => `<div class="json-property"><span class="json-key">"${k}"</span>: ${formatValue(value[k])}</div>`).join('')}
            </div>
            <span class="json-bracket">}</span>
        `;
    }
    
    return escapeHtml(String(value));
}

function setupDiffControls() {
    // Add event listeners for visibility toggles
    document.querySelectorAll('.toggle-unchanged').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            toggleDiffType('unchanged', checkbox.checked);
        });
    });
    
    document.querySelectorAll('.toggle-modified').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            toggleDiffType('modified', checkbox.checked);
        });
    });
    
    document.querySelectorAll('.toggle-added').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            toggleDiffType('added', checkbox.checked);
        });
    });
    
    document.querySelectorAll('.toggle-removed').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            toggleDiffType('removed', checkbox.checked);
        });
    });
}

function toggleDiffType(type, show) {
    const elements = document.querySelectorAll(`.diff-${type}`);
    elements.forEach(el => {
        if (show) {
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
        }
    });
}

function toggleExpand(elementId) {
    const element = document.getElementById(elementId);
    const expander = element.previousElementSibling;
    const preview = document.getElementById(elementId + '-preview');
    
    if (element.classList.contains('hidden')) {
        element.classList.remove('hidden');
        expander.textContent = '‚ñº';
        if (preview) preview.style.display = 'none';
    } else {
        element.classList.add('hidden');
        expander.textContent = '‚ñ∂';
        if (preview) preview.style.display = 'inline';
    }
}

// Video Downloader logic
const videoDrop = document.getElementById('video-drop');
const videoUrlInput = document.getElementById('video-url');
const videoDownloadBtn = document.getElementById('video-download-btn');
const videoLink = document.getElementById('video-download-link');
const videoStatus = document.getElementById('video-status');

function updateVideoButton() {
    videoDownloadBtn.disabled = !videoUrlInput.value.trim();
}

['dragenter', 'dragover'].forEach(ev => {
    videoDrop.addEventListener(ev, e => {
        e.preventDefault();
        videoDrop.classList.add('hover');
    });
});
['dragleave', 'drop'].forEach(ev => {
    videoDrop.addEventListener(ev, e => {
        e.preventDefault();
        videoDrop.classList.remove('hover');
    });
});
videoDrop.addEventListener('drop', e => {
    const url = e.dataTransfer.getData('text/plain');
    if (url) {
        videoUrlInput.value = url.trim();
        updateVideoButton();
    }
});
videoDrop.addEventListener('paste', e => {
    const text = (e.clipboardData || window.clipboardData).getData('text');
    if (text) {
        videoUrlInput.value = text.trim();
        updateVideoButton();
    }
});
videoUrlInput.addEventListener('input', updateVideoButton);

videoDownloadBtn.addEventListener('click', async () => {
    const url = videoUrlInput.value.trim();
    if (!url) return;
    videoStatus.textContent = 'Fetching video...';
    try {
        const resp = await fetch('/tools/download_video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
        });
        if (!resp.ok) throw new Error('Server error');
        const blob = await resp.blob();
        const dlUrl = URL.createObjectURL(blob);
        let filename = 'video.mp4';
        const cd = resp.headers.get('Content-Disposition');
        if (cd) {
            const m = cd.match(/filename="?(.+?)"?$/);
            if (m) filename = m[1];
        }
        videoLink.href = dlUrl;
        videoLink.download = filename;
        videoLink.click();
        videoStatus.textContent = 'Download started.';
    } catch (err) {
        videoStatus.textContent = 'Error: ' + err.message;
    }
});

// Helper functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function generateId() {
    return Math.random().toString(36).substr(2, 9);
}

function getValueType(value) {
    if (value === null) return 'null';
    if (Array.isArray(value)) return 'array';
    return typeof value;
}

function isObject(value) {
    return value !== null && typeof value === 'object' && !Array.isArray(value);
}

function deepEqual(a, b) {
    if (a === b) return true;
    if (a == null || b == null) return false;
    if (typeof a !== typeof b) return false;
    
    if (Array.isArray(a)) {
        if (!Array.isArray(b) || a.length !== b.length) return false;
        for (let i = 0; i < a.length; i++) {
            if (!deepEqual(a[i], b[i])) return false;
        }
        return true;
    }
    
    if (typeof a === 'object') {
        const keysA = Object.keys(a);
        const keysB = Object.keys(b);
        if (keysA.length !== keysB.length) return false;
        for (const key of keysA) {
            if (!b.hasOwnProperty(key) || !deepEqual(a[key], b[key])) return false;
        }
        return true;
    }
    
    return false;
}

// Global function for expand/collapse (accessible from onclick)
window.toggleExpand = toggleExpand;
</script>

</body>
</html>

