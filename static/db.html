<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin:0 auto; padding:1rem; max-width:800px; }
        #controls { display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem; }
        #controls > button, #controls > select { margin-bottom:0.5rem; }
        table { border-collapse: collapse; margin-bottom:1rem; }
        th, td { border: 1px solid #ccc; padding: 0.25rem 0.5rem; }
        caption { font-weight:bold; margin-bottom:0.25rem; }
        #map { width:100%; height:40vh; margin-bottom:1rem; }
        #scale-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        #scale-bar {
            flex: 1;
            height: 12px;
            background: linear-gradient(to right, green, yellow, red);
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h1>Database Management</h1>
<div id="page-links" style="margin-bottom:1rem;">
    <a href="/">Main</a> |
    <a href="experimental.html">Experimental</a> |
    <a href="device.html">Device View</a>
</div>
<div id="controls">
    <button onclick="loadTables()">Refresh Tables</button>
    <button onclick="insertTest()">Insert Test Data</button>
    <select id="table-select"></select>
    <button onclick="deleteRecords()">Delete All Records</button>
    <button onclick="backupTable()">Backup Table</button>
    <button onclick="renameTable()">Rename Table</button>
</div>
<div id="map"></div>
<div id="scale-container">
    <span>Smooth</span>
    <div id="scale-bar"></div>
    <span>Rough</span>
</div>
<div id="record-editor" style="display:none; border:1px solid #ccc; padding:0.5rem; margin-bottom:1rem;">
    <h3>Selected Record</h3>
    <form id="record-form">
        <div>ID <input id="rec-id" readonly></div>
        <div>Latitude <input id="rec-lat"></div>
        <div>Longitude <input id="rec-lon"></div>
        <div>Speed <input id="rec-speed"></div>
        <div>Direction <input id="rec-dir"></div>
        <div>Roughness <input id="rec-rough"></div>
        <div>Distance <input id="rec-dist"></div>
        <div>Device ID <input id="rec-dev"></div>
        <div>IP <input id="rec-ip"></div>
        <button type="button" onclick="saveRecord()">Save Changes</button>
        <button type="button" onclick="removeRecord()">Delete</button>
    </form>
</div>
<div id="output"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let roughMin = 0;
let roughMax = 10;
let roughAvg = 0;

async function authFetch(url, options) {
    let res = await fetch(url, options);
    if (res.status === 401) {
        const pw = prompt('Password:');
        if (!pw) throw new Error('Password required');
        const loginRes = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw })
        });
        if (!loginRes.ok) throw new Error('Login failed');
        res = await fetch(url, options);
    }
    return res;
}

function initMap() {
    const defaultPos = [52.028, 5.168];
    const zoom = 12;
    map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const setView = c => map.setView(c, zoom);
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => setView([pos.coords.latitude, pos.coords.longitude]),
            () => setView(defaultPos),
            { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
        );
    } else {
        setView(defaultPos);
    }
}

function colorForRoughness(r) {
    let ratio = 0;
    if (roughAvg > 0) {
        ratio = r / (roughAvg * 2);
    } else if (roughMax !== roughMin) {
        ratio = (r - roughMin) / (roughMax - roughMin);
    }
    ratio = Math.min(Math.max(ratio, 0), 1);
    const red = Math.floor(255 * ratio);
    const green = Math.floor(255 * (1 - ratio));
    return `rgb(${red},${green},0)`;
}

function addPoint(lat, lon, info) {
    if (!map) return;
    const marker = L.circleMarker(
        [lat, lon],
        { radius:4, weight:1, opacity:0.9, fillOpacity:0.9, color: colorForRoughness(info ? info.roughness : 0) }
    ).addTo(map);
    if (info) {
        marker.bindPopup('ID: ' + info.id + '<br>Roughness: ' + info.roughness.toFixed(2));
        marker.on('click', () => { localStorage.setItem('selectedRecordId', info.id); loadSelected(); });
    }
}

async function loadLogs() {
    const res = await authFetch('/logs');
    const data = await res.json();
    const rows = Array.isArray(data) ? data : data.rows;
    roughAvg = data.average || 0;
    roughMin = 0;
    roughMax = roughAvg > 0 ? roughAvg * 2 : 1;
    if (rows.length > 0) {
        roughMin = Math.min(...rows.map(r => r.roughness));
        roughMax = Math.max(...rows.map(r => r.roughness));
    }
    if (map) {
        map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });
    }
    rows.reverse().forEach(r => addPoint(r.latitude, r.longitude, r));
}

async function loadTables(selected) {
    const res = await authFetch('/manage/tables');
    const data = await res.json();
    const select = document.getElementById('table-select');
    const current = selected || select.value;
    select.innerHTML = '';
    for (const name of Object.keys(data.tables)) {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; select.appendChild(opt);
    }
    if (current) select.value = current;
    if (!select.value && select.options.length > 0)
        select.value = select.options[0].value;
    const tableName = select.value;
    const out = document.getElementById('output');
    out.innerHTML = '';
    const rows = data.tables[tableName] || [];
    if (!tableName) return;
    const table = document.createElement('table');
    const caption = document.createElement('caption');
    caption.textContent = tableName; table.appendChild(caption);
    if (rows.length > 0) {
        const head = document.createElement('tr');
        for (const col of Object.keys(rows[0])) {
            const th = document.createElement('th'); th.textContent = col; head.appendChild(th);
        }
        table.appendChild(head);
        for (const row of rows) {
            const tr = document.createElement('tr');
            for (const val of Object.values(row)) {
                const td = document.createElement('td'); td.textContent = val; tr.appendChild(td);
            }
            table.appendChild(tr);
        }
    } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.textContent = '(no rows)'; td.colSpan = 1; tr.appendChild(td); table.appendChild(tr);
    }
    out.appendChild(table);
}
async function insertTest() {
    const t = document.getElementById('table-select').value; if(!t) return;
    await authFetch('/manage/insert_testdata', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({table:t})});
    loadTables(t);
}
async function deleteRecords() {
    const t = document.getElementById('table-select').value; if(!t) return;
    await authFetch('/manage/delete_all?table='+encodeURIComponent(t), {method:'DELETE'});
    loadTables(t);
}
async function backupTable() {
    const t = document.getElementById('table-select').value; if(!t) return;
    const res = await authFetch('/manage/backup_table', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({table:t})
    });
    const data = await res.json();
    alert('Backup created: '+data.new_table);
    loadTables(data.new_table);
}
async function renameTable() {
    const t = document.getElementById('table-select').value; if(!t) return;
    const newName = prompt('New table name', t);
    if(!newName || newName === t) return;
    await authFetch('/manage/rename_table', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({old_name:t, new_name:newName})
    });
    loadTables(newName);
}

function loadSelected() {
    const id = localStorage.getItem('selectedRecordId');
    if(!id) return;
    authFetch('/manage/record?record_id='+encodeURIComponent(id))
        .then(r=>r.json()).then(row=>{
            document.getElementById('record-editor').style.display='block';
            document.getElementById('rec-id').value=row.id;
            document.getElementById('rec-lat').value=row.latitude;
            document.getElementById('rec-lon').value=row.longitude;
            document.getElementById('rec-speed').value=row.speed;
            document.getElementById('rec-dir').value=row.direction;
            document.getElementById('rec-rough').value=row.roughness;
            document.getElementById('rec-dist').value=row.distance_m;
            document.getElementById('rec-dev').value=row.device_id;
            document.getElementById('rec-ip').value=row.ip_address || '';
        }).catch(console.error);
}

async function saveRecord() {
    const id = document.getElementById('rec-id').value;
    const body = {
        id: parseInt(id,10),
        latitude: parseFloat(document.getElementById('rec-lat').value),
        longitude: parseFloat(document.getElementById('rec-lon').value),
        speed: parseFloat(document.getElementById('rec-speed').value),
        direction: parseFloat(document.getElementById('rec-dir').value),
        roughness: parseFloat(document.getElementById('rec-rough').value),
        distance_m: parseFloat(document.getElementById('rec-dist').value),
        device_id: document.getElementById('rec-dev').value,
        ip_address: document.getElementById('rec-ip').value
    };
    await authFetch('/manage/update_record', {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
    });
    loadTables('bike_data');
}

async function removeRecord() {
    const id = document.getElementById('rec-id').value;
    if(!id) return;
    await authFetch('/manage/delete_record?record_id='+encodeURIComponent(id), {method:'DELETE'});
    document.getElementById('record-editor').style.display='none';
    localStorage.removeItem('selectedRecordId');
    loadTables('bike_data');
}
initMap();
loadLogs();
loadTables();
loadSelected();
</script>
</body>
</html>
