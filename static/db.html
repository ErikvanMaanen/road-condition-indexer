<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin:0 auto; padding:1rem; max-width:800px; }
        #controls { display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem; }
        #controls > button, #controls > select { margin-bottom:0.5rem; }
        table { border-collapse: collapse; margin-bottom:1rem; }
        th, td { border: 1px solid #ccc; padding: 0.25rem 0.5rem; }
        caption { font-weight:bold; margin-bottom:0.25rem; }
        #map { width:100%; height:40vh; margin-bottom:1rem; }
        #scale-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
        }
        #scale-bar {
            flex: 1;
            height: 12px;
            background: linear-gradient(to right, green, yellow, red);
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h1>Database Management</h1>
<nav id="page-links" style="margin-bottom:1rem;">
    <a href="/">Main</a> |
    <a href="experimental.html">Experimental</a> |
    <a href="device.html">Device View</a> |
    <a href="maintenance.html">Maintenance</a>
</nav>
<section id="filter-dev" style="margin-bottom:1rem;">
    <select id="filter-device" multiple></select>
    <select id="roughness-filter" multiple>
        <option value="">[All Roughness]</option>
        <option value="1">1 - Glass-smooth</option>
        <option value="2">2 - Smooth concrete</option>
        <option value="3">3 - Good asphalt</option>
        <option value="4">4 - Coarse asphalt</option>
        <option value="5">5 - Medium chip seal</option>
        <option value="6">6 - Worn cobbles</option>
        <option value="7">7 - Fine gravel</option>
        <option value="8">8 - Rough gravel</option>
        <option value="9">9 - Large potholes</option>
        <option value="10">10 - Impassable</option>
    </select>
    </select>
</section>
<section id="filter-time" style="margin-bottom:1rem;">
    <input id="filter-start" type="datetime-local">
    <input id="filter-end" type="datetime-local">
    <input id="filter-ids" placeholder="IDs (comma)">
    <button onclick="loadFiltered()">Load Filter</button>
    <button onclick="deleteFiltered()">Delete Filter</button>
</section>
<div id="map"></div>
<div id="scale-container">
    <span>Smooth</span>
    <div id="scale-bar"></div>
    <span>Rough</span>
</div>
<section id="controls" style="margin-bottom:1rem;">
    <button onclick="loadTables()">Refresh Tables</button>
    <button onclick="insertTest()">Insert Test Data</button>
</section>
<section id="table-actions" style="margin-bottom:1rem;">
    <h3>Table: <select id="table-select"></select></h3>
    <button onclick="loadSelectedTable()">Load Selected</button>
    <button onclick="deleteRecords()">Delete All Records</button>
    <button onclick="backupTable()">Backup Table</button>
    <button onclick="renameTable()">Rename Table</button>
    <button id="toggle-table" onclick="toggleTable()">Show Table</button>
</section>
<section id="merge-section" style="margin-bottom:1rem;">
    <h3>Merge Device IDs</h3>
    <select id="merge-old"></select>
    <select id="merge-new"></select>
    <button onclick="mergeIds()">Merge IDs</button>
</section>
<div id="record-editor" style="display:none; border:1px solid #ccc; padding:0.5rem; margin-bottom:1rem;">
        <h3>Selected Record</h3>
        <form id="record-form">
            <div>ID <input id="rec-id" readonly></div>
            <div>Latitude <input id="rec-lat"></div>
            <div>Longitude <input id="rec-lon"></div>
            <div>Speed <input id="rec-speed"></div>
            <div>Direction <input id="rec-dir"></div>
            <div>Roughness <input id="rec-rough"></div>
            <div>Distance <input id="rec-dist"></div>
            <div>Device ID <input id="rec-dev"></div>
            <div>IP <input id="rec-ip"></div>
            <button type="button" onclick="saveRecord()">Save Changes</button>
            <button type="button" onclick="removeRecord()">Delete</button>
        </form>
    </div>
    <div id="output" style="display:none;"></div>
</section>
<section id="logs" style="margin-bottom:1rem;">
    <h3>Activity Log</h3>
    <div id="log"></div>
    <h3>Debug Messages</h3>
    <textarea id="debug" readonly></textarea>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let roughMin = 0;
const LABEL_COUNT = 10;
let roughMax = LABEL_COUNT;
let roughAvg = 0;
let currentTable = '';
let currentColumns = [];
let showTable = false;
let tableRows = [];

async function authFetch(url, options) {
    let res = await fetch(url, options);
    if (res.status === 401) {
        const pw = prompt('Password:');
        if (!pw) throw new Error('Password required');
        const loginRes = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw })
        });
        if (!loginRes.ok) throw new Error('Login failed');
        res = await fetch(url, options);
    }
    return res;
}

function initMap() {
    const defaultPos = [52.028, 5.168];
    const zoom = 12;
    map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const setView = c => map.setView(c, zoom);
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => setView([pos.coords.latitude, pos.coords.longitude]),
            () => setView(defaultPos),
            { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
        );
    } else {
        setView(defaultPos);
    }
    addFullscreenControl(map);
}

function addFullscreenControl(m) {
    const Full = L.Control.extend({
        onAdd: function() {
            const btn = L.DomUtil.create('button', 'leaflet-bar');
            btn.textContent = 'â¤¢';
            L.DomEvent.on(btn, 'click', () => {
                const el = m.getContainer();
                addLog('Fullscreen button pressed');
                if (!document.fullscreenElement) {
                    el.requestFullscreen?.();
                } else {
                    document.exitFullscreen?.();
                }
            });
            return btn;
        }
    });
    m.addControl(new Full({position:'topleft'}));
}

function addLog(msg) {
    const div = document.getElementById('log');
    if (div) {
        div.textContent += msg + '\n';
        div.scrollTop = div.scrollHeight;
    }
}

function addDebug(msg) {
    const el = document.getElementById('debug');
    if (el) {
        el.value += msg + '\n';
        el.scrollTop = el.scrollHeight;
    }
}

function populateDeviceOptions() {
    fetch('/device_ids').then(r => r.json()).then(data => {
        const ids = ['merge-old','merge-new','filter-device'];
        ids.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const current = Array.from(sel.selectedOptions).map(o => o.value);
            sel.innerHTML = '';
            data.ids.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.nickname ? `${item.nickname} (${item.id})` : item.id;
                sel.appendChild(opt);
            });
            current.forEach(v => {
                Array.from(sel.options).forEach(o => { if (o.value === v) o.selected = true; });
            });
        });
    }).catch(console.error);
}

function colorForRoughness(r) {
    let ratio = 0;
    if (roughAvg > 0) {
        ratio = r / (roughAvg * 2);
    } else if (roughMax !== roughMin) {
        ratio = (r - roughMin) / (roughMax - roughMin);
    }
    ratio = Math.min(Math.max(ratio, 0), 1);
    const red = Math.floor(255 * ratio);
    const green = Math.floor(255 * (1 - ratio));
    return `rgb(${red},${green},0)`;
}

function roughnessLabel(r) {
    let min = roughMin;
    let max = roughMax;
    if (max === min) {
        if (roughAvg > 0) {
            min = 0;
            max = roughAvg * 2;
        } else {
            max = min + LABEL_COUNT;
        }
    }
    const offset = 1;
    let logMin = Math.log(min + offset);
    let logMax = Math.log(max + offset);
    if (logMax === logMin) logMax = logMin + 1;
    const ratio = (Math.log(r + offset) - logMin) / (logMax - logMin);
    const idx = Math.max(0, Math.min(LABEL_COUNT - 1, Math.floor(ratio * LABEL_COUNT)));
    return String(idx + 1);
}

function filterRoughness(r) {
    const sel = document.getElementById('roughness-filter');
    if (!sel) return true;
    const values = Array.from(sel.selectedOptions).map(o => o.value).filter(v => v);
    if (values.length === 0) return true;
    return values.includes(roughnessLabel(r));
}

function addPoint(lat, lon, info) {
    if (!map || (lat === 0 && lon === 0)) return;
    const rough = info && typeof info.roughness === 'number' ? info.roughness : 0;
    const marker = L.circleMarker(
        [lat, lon],
        { radius:4, weight:1, opacity:0.9, fillOpacity:0.9, color: colorForRoughness(rough) }
    ).addTo(map);
    if (info) {
        const timeStr = info.timestamp ? new Date(info.timestamp).toLocaleString() : '';
        let popup = '';
        if (timeStr) popup += `Time: ${timeStr}<br>`;
        if ('speed' in info) popup += `Speed: ${Number(info.speed).toFixed(1)} km/h<br>`;
        if ('direction' in info) popup += `Dir: ${directionToCompass(info.direction)}<br>`;
        if ('roughness' in info)
            popup += `Roughness: ${roughnessLabel(info.roughness)} (${Number(info.roughness).toFixed(2)})`;
        if (popup) marker.bindPopup(popup);
        if ('id' in info) {
            marker.on('click', () => { localStorage.setItem('selectedRecordId', info.id); loadSelected(); });
        }
    }
}

function updateMap(rows) {
    if (!map) return;
    map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });
    roughAvg = 0;
    roughMin = 0;
    roughMax = 1;
    if (!rows || rows.length === 0) return;
    if ('roughness' in rows[0]) {
        roughMin = Math.min(...rows.map(r => parseFloat(r.roughness || 0)));
        roughMax = Math.max(...rows.map(r => parseFloat(r.roughness || 0)));
        roughAvg = rows.reduce((a,r)=>a+parseFloat(r.roughness||0),0)/rows.length;
    }
    rows.slice().reverse().forEach(r => {
        if ('latitude' in r && 'longitude' in r) {
            if (!('roughness' in r) || filterRoughness(parseFloat(r.roughness))) {
                addPoint(parseFloat(r.latitude), parseFloat(r.longitude), r);
            }
        }
    });
}

async function loadLogs() {
    const res = await authFetch('/logs');
    const data = await res.json();
    const rows = Array.isArray(data) ? data : data.rows;
    updateMap(rows);
}

async function loadTables(selected) {
    addLog('Refresh Tables pressed');
    const res = await authFetch('/manage/tables');
    const data = await res.json();
    const select = document.getElementById('table-select');
    const current = selected || select.value;
    select.innerHTML = '';
    for (const name of Object.keys(data.tables)) {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; select.appendChild(opt);
    }
    if (current) select.value = current;
    if (!select.value && select.options.length > 0)
        select.value = select.options[0].value;
}
async function insertTest() {
    const t = document.getElementById('table-select').value; if(!t) return;
    addLog('Insert Test Data pressed');
    await authFetch('/manage/insert_testdata', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({table:t})});
    await loadTables(t);
    loadSelectedTable();
}
async function deleteRecords() {
    const t = document.getElementById('table-select').value; if(!t) return;
    addLog('Delete All Records pressed');
    await authFetch('/manage/delete_all?table='+encodeURIComponent(t), {method:'DELETE'});
    await loadTables(t);
    loadSelectedTable();
}
async function backupTable() {
    const t = document.getElementById('table-select').value; if(!t) return;
    addLog('Backup Table pressed');
    const res = await authFetch('/manage/backup_table', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({table:t})
    });
    const data = await res.json();
    alert('Backup created: '+data.new_table);
    await loadTables(data.new_table);
    loadSelectedTable();
}

function setCurrentColumns(cols) {
    currentColumns = cols;
    buildRecordEditor();
}

function buildRecordEditor() {
    const form = document.getElementById('record-form');
    form.innerHTML = '';
    currentColumns.forEach(col => {
        const div = document.createElement('div');
        div.textContent = col + ' ';
        const input = document.createElement('input');
        input.id = 'rec-' + col;
        if (col === 'id') input.readOnly = true;
        div.appendChild(input);
        form.appendChild(div);
    });
    const save = document.createElement('button');
    save.type = 'button';
    save.textContent = 'Save Changes';
    save.onclick = saveRecord;
    form.appendChild(save);
    const del = document.createElement('button');
    del.type = 'button';
    del.textContent = 'Delete';
    del.onclick = removeRecord;
    form.appendChild(del);
    document.getElementById('record-editor').style.display = 'none';
}

function renderTable(name, rows) {
    const out = document.getElementById('output');
    out.innerHTML = '';
    const table = document.createElement('table');
    const caption = document.createElement('caption');
    caption.textContent = name;
    table.appendChild(caption);
    if (rows.length > 0) {
        const head = document.createElement('tr');
        for (const col of Object.keys(rows[0])) {
            const th = document.createElement('th');
            th.textContent = col;
            head.appendChild(th);
        }
        table.appendChild(head);
        for (const row of rows) {
            const tr = document.createElement('tr');
            tr.addEventListener('click', () => showRow(row));
            for (const val of Object.values(row)) {
                const td = document.createElement('td');
                td.textContent = val;
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
    } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.textContent = '(no rows)';
        td.colSpan = 1;
        tr.appendChild(td);
        table.appendChild(tr);
    }
    out.appendChild(table);
}

function showRow(row) {
    setCurrentColumns(Object.keys(row));
    const editor = document.getElementById('record-editor');
    editor.style.display = 'block';
    currentColumns.forEach(col => {
        const input = document.getElementById('rec-' + col);
        if (input) input.value = row[col] != null ? row[col] : '';
    });
}

async function loadSelectedTable() {
    addLog('Load Selected Table pressed');
    const tableName = document.getElementById('table-select').value;
    if (!tableName) return;
    const res = await authFetch('/manage/table_rows?table=' + encodeURIComponent(tableName));
    if(!res.ok) return;
    const data = await res.json();
    const rows = data.rows || [];
    currentTable = tableName;
    setCurrentColumns(rows.length > 0 ? Object.keys(rows[0]) : []);
    tableRows = rows;
    if (showTable) {
        renderTable(tableName, rows);
        document.getElementById('output').style.display='block';
    } else {
        document.getElementById('output').style.display='none';
    }
    updateMap(rows);
}
async function renameTable() {
    const t = document.getElementById('table-select').value; if(!t) return;
    const newName = prompt('New table name', t);
    if(!newName || newName === t) return;
    addLog('Rename Table pressed');
    await authFetch('/manage/rename_table', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({old_name:t, new_name:newName})
    });
    await loadTables(newName);
    loadSelectedTable();
}

async function mergeIds() {
    const oldId = document.getElementById('merge-old').value;
    const newId = document.getElementById('merge-new').value;
    if(!oldId || !newId || oldId === newId) return;
    addLog('Merge IDs pressed');
    await authFetch('/manage/merge_device_ids', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({old_id: oldId, new_id: newId})
    });
    alert('Merge completed');
    populateDeviceOptions();
    loadTables();
    if(currentTable === 'bike_data') loadSelectedTable();
}

function buildFilterParams() {
    const params = new URLSearchParams();
    const devSel = document.getElementById('filter-device');
    if (devSel) {
        Array.from(devSel.selectedOptions).forEach(o => params.append('device_id', o.value));
    }
    const start = document.getElementById('filter-start').value;
    const end = document.getElementById('filter-end').value;
    if (start) params.append('start', start);
    if (end) params.append('end', end);
    const ids = document.getElementById('filter-ids').value.trim();
    if (ids) ids.split(/[,\s]+/).forEach(id => { if(id) params.append('ids', id); });
    return params;
}

async function loadFiltered() {
    addLog('Load Filter pressed');
    const params = buildFilterParams();
    const res = await authFetch('/manage/filtered_records?' + params.toString());
    if(!res.ok) return;
    const data = await res.json();
    const rows = data.rows || [];
    currentTable = 'bike_data';
    setCurrentColumns(rows.length > 0 ? Object.keys(rows[0]) : []);
    tableRows = rows;
    if (showTable) {
        renderTable('bike_data', rows);
        document.getElementById('output').style.display='block';
    } else {
        document.getElementById('output').style.display='none';
    }
    updateMap(rows);
}

async function deleteFiltered() {
    addLog('Delete Filter pressed');
    const params = buildFilterParams();
    const res = await authFetch('/manage/delete_filtered_records?' + params.toString(), {method:'DELETE'});
    if(res.ok) {
        const data = await res.json();
        alert('Deleted ' + data.deleted + ' records');
        loadFiltered();
        loadTables();
    }
}

function loadSelected() {
    const id = localStorage.getItem('selectedRecordId');
    if(!id) return;
    authFetch('/manage/record?record_id='+encodeURIComponent(id))
        .then(r=>r.json()).then(row=>{
            showRow(row);
        }).catch(console.error);
}

async function saveRecord() {
    if(currentTable !== 'bike_data') return;
    addLog('Save Record pressed');
    const body = { id: parseInt(document.getElementById('rec-id').value,10) };
    currentColumns.forEach(col => {
        if(col === 'id') return;
        const input = document.getElementById('rec-' + col);
        if(!input) return;
        if(input.value === '') return;
        body[col] = isNaN(parseFloat(input.value)) || col === 'device_id' || col === 'ip_address'
            ? input.value
            : parseFloat(input.value);
    });
    await authFetch('/manage/update_record', {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
    });
    loadSelectedTable();
}

async function removeRecord() {
    if(currentTable !== 'bike_data') return;
    addLog('Delete Record pressed');
    const id = document.getElementById('rec-id').value;
    if(!id) return;
    await authFetch('/manage/delete_record?record_id='+encodeURIComponent(id), {method:'DELETE'});
    document.getElementById('record-editor').style.display='none';
    localStorage.removeItem('selectedRecordId');
    loadSelectedTable();
}

function toggleTable() {
    showTable = !showTable;
    addLog('Toggle Table pressed');
    document.getElementById('toggle-table').textContent = showTable ? 'Hide Table' : 'Show Table';
    if(showTable) {
        renderTable(currentTable, tableRows);
        document.getElementById('output').style.display='block';
    } else {
        document.getElementById('output').innerHTML='';
        document.getElementById('output').style.display='none';
    }
}
initMap();
populateDeviceOptions();
loadTables().then(() => { loadSelectedTable(); });
document.getElementById('table-select').addEventListener('change', loadSelectedTable);
document.getElementById('filter-device').addEventListener('change', loadFiltered);
document.getElementById('roughness-filter').addEventListener('change', () => {
    updateMap(tableRows);
});
loadLogs();
loadSelected();
</script>
</body>
</html>
