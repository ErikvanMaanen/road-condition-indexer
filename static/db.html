<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap">
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#6200ee">
</head>
<body>
<h1>Database Management</h1>
<p><a href="/">Back to Main</a></p>
<div id="controls">
    <button onclick="loadTables()">Refresh Tables</button>
    <button onclick="insertTest()">Insert Test Data</button>
    <select id="table-select"></select>
    <button onclick="deleteRecords()">Delete All Records</button>
    <button onclick="backupTable()">Backup Table</button>
    <button onclick="renameTable()">Rename Table</button>
</div>
<div id="record-editor">
    <h3>Selected Record</h3>
    <form id="record-form">
        <div>ID <input id="rec-id" readonly></div>
        <div>Latitude <input id="rec-lat"></div>
        <div>Longitude <input id="rec-lon"></div>
        <div>Speed <input id="rec-speed"></div>
        <div>Direction <input id="rec-dir"></div>
        <div>Roughness <input id="rec-rough"></div>
        <div>Distance <input id="rec-dist"></div>
        <div>Device ID <input id="rec-dev"></div>
        <div>IP <input id="rec-ip"></div>
        <button type="button" onclick="saveRecord()">Save Changes</button>
        <button type="button" onclick="removeRecord()">Delete</button>
    </form>
</div>
<div id="output"></div>
<script>
async function loadTables(selected) {
    const res = await fetch('/manage/tables');
    const data = await res.json();
    const select = document.getElementById('table-select');
    const current = selected || select.value;
    select.innerHTML = '';
    for (const name of Object.keys(data.tables)) {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name; select.appendChild(opt);
    }
    if (current) select.value = current;
    if (!select.value && select.options.length > 0)
        select.value = select.options[0].value;
    const tableName = select.value;
    const out = document.getElementById('output');
    out.innerHTML = '';
    const rows = data.tables[tableName] || [];
    if (!tableName) return;
    const table = document.createElement('table');
    const caption = document.createElement('caption');
    caption.textContent = tableName; table.appendChild(caption);
    if (rows.length > 0) {
        const head = document.createElement('tr');
        for (const col of Object.keys(rows[0])) {
            const th = document.createElement('th'); th.textContent = col; head.appendChild(th);
        }
        table.appendChild(head);
        for (const row of rows) {
            const tr = document.createElement('tr');
            for (const val of Object.values(row)) {
                const td = document.createElement('td'); td.textContent = val; tr.appendChild(td);
            }
            table.appendChild(tr);
        }
    } else {
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.textContent = '(no rows)'; td.colSpan = 1; tr.appendChild(td); table.appendChild(tr);
    }
    out.appendChild(table);
}
async function insertTest() {
    const t = document.getElementById('table-select').value; if(!t) return;
    await fetch('/manage/insert_testdata', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({table:t})});
    loadTables(t);
}
async function deleteRecords() {
    const t = document.getElementById('table-select').value; if(!t) return;
    await fetch('/manage/delete_all?table='+encodeURIComponent(t), {method:'DELETE'});
    loadTables(t);
}
async function backupTable() {
    const t = document.getElementById('table-select').value; if(!t) return;
    const res = await fetch('/manage/backup_table', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({table:t})
    });
    const data = await res.json();
    alert('Backup created: '+data.new_table);
    loadTables(data.new_table);
}
async function renameTable() {
    const t = document.getElementById('table-select').value; if(!t) return;
    const newName = prompt('New table name', t);
    if(!newName || newName === t) return;
    await fetch('/manage/rename_table', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({old_name:t, new_name:newName})
    });
    loadTables(newName);
}

function loadSelected() {
    const id = localStorage.getItem('selectedRecordId');
    if(!id) return;
    fetch('/manage/record?record_id='+encodeURIComponent(id))
        .then(r=>r.json()).then(row=>{
            document.getElementById('record-editor').style.display='block';
            document.getElementById('rec-id').value=row.id;
            document.getElementById('rec-lat').value=row.latitude;
            document.getElementById('rec-lon').value=row.longitude;
            document.getElementById('rec-speed').value=row.speed;
            document.getElementById('rec-dir').value=row.direction;
            document.getElementById('rec-rough').value=row.roughness;
            document.getElementById('rec-dist').value=row.distance_m;
            document.getElementById('rec-dev').value=row.device_id;
            document.getElementById('rec-ip').value=row.ip_address || '';
        }).catch(console.error);
}

async function saveRecord() {
    const id = document.getElementById('rec-id').value;
    const body = {
        id: parseInt(id,10),
        latitude: parseFloat(document.getElementById('rec-lat').value),
        longitude: parseFloat(document.getElementById('rec-lon').value),
        speed: parseFloat(document.getElementById('rec-speed').value),
        direction: parseFloat(document.getElementById('rec-dir').value),
        roughness: parseFloat(document.getElementById('rec-rough').value),
        distance_m: parseFloat(document.getElementById('rec-dist').value),
        device_id: document.getElementById('rec-dev').value,
        ip_address: document.getElementById('rec-ip').value
    };
    await fetch('/manage/update_record', {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
    });
    loadTables('bike_data');
}

async function removeRecord() {
    const id = document.getElementById('rec-id').value;
    if(!id) return;
    await fetch('/manage/delete_record?record_id='+encodeURIComponent(id), {method:'DELETE'});
    document.getElementById('record-editor').style.display='none';
    localStorage.removeItem('selectedRecordId');
    loadTables('bike_data');
}
loadTables();
loadSelected();
</script>
</body>
</html>
